<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="SpeakPro - Learn English & Hindi through conversation">
    <title>SpeakPro - Glass PWA</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="1000094592.jpg">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&family=Ramabhadra&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* GLOBAL GLASS STYLES */
        body { 
            font-family: 'Open Sans', sans-serif; 
            /* Fixed Background Image */
            background-image: url('1000094592.jpg'); 
            background-size: cover; 
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent; 
        }

        /* Glass Utility Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .glass-bubble-ai {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: #1e293b;
            border-radius: 18px 18px 18px 0;
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .font-telugu { font-family: 'Ramabhadra', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .bubble-user { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border-radius: 18px 18px 0 18px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .feedback-box { background: rgba(255, 251, 235, 0.9); border-left: 4px solid #f59e0b; color: #92400e; font-size: 0.85rem; backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 25 ENHANCED SCENARIOS ---
        const SCENARIOS = [
            { id: 1, icon: "ph-users-three", title: "Family (కుటుంబం)", prompt: "Role: Caring Mother. Context: Asking child about school and lunch.", startMsg: "Hello my dear! How was school today? Did you eat your lunch?" },
            { id: 2, icon: "ph-confetti", title: "Friends (స్నేహితులు)", prompt: "Role: Best Friend. Context: Planning a movie for the weekend.", startMsg: "Hey buddy! Long time no see. Are we going to the movie this Saturday?" },
            { id: 3, icon: "ph-briefcase", title: "Colleagues (ఆఫీస్)", prompt: "Role: Project Manager. Context: Asking about the project deadline status.", startMsg: "Hi, good morning. Have you completed the report I asked for yesterday?" },
            { id: 4, icon: "ph-carrot", title: "Vegetable Market (కూరగాయలు)", prompt: "Role: Vegetable Vendor. Context: Selling fresh tomatoes and negotiating price.", startMsg: "Madam! Fresh tomatoes just arrived. Only 40 rupees a kilo. How much do you need?" },
            { id: 5, icon: "ph-stethoscope", title: "Doctor (డాక్టర్)", prompt: "Role: Doctor. Context: Diagnosing fever and cold symptoms.", startMsg: "Hello. Please sit down. What seems to be the problem today?" },
            { id: 6, icon: "ph-fork-knife", title: "Restaurant (రెస్టారెంట్)", prompt: "Role: Waiter. Context: Taking order for dinner.", startMsg: "Good evening sir/madam. Here is the menu. Would you like to start with some soup?" },
            { id: 7, icon: "ph-user-focus", title: "Job Interview (ఇంటర్వ్యూ)", prompt: "Role: HR Manager. Context: Interviewing for a software developer role.", startMsg: "Welcome. Please introduce yourself and tell me about your experience." },
            { id: 8, icon: "ph-map-pin", title: "Asking Directions (చిరునామా)", prompt: "Role: Local Stranger. Context: Helping someone find the post office.", startMsg: "Excuse me? Are you lost? Where do you want to go?" },
            { id: 9, icon: "ph-bus", title: "Bus Station (బస్)", prompt: "Role: Bus Conductor. Context: Asking for tickets and destination.", startMsg: "Ticket! Ticket! Where to? Move to the back please." },
            { id: 10, icon: "ph-bank", title: "Bank (బ్యాంకు)", prompt: "Role: Bank Manager. Context: Discussing a personal loan application.", startMsg: "Good morning. You wanted to apply for a personal loan, right? Do you have your ID proof?" },
            { id: 11, icon: "ph-shopping-bag", title: "Shopping Mall (షాపింగ్)", prompt: "Role: Sales Executive. Context: Helping customer choose a shirt.", startMsg: "Hello sir. Looking for formal shirts or casuals? We have a new collection." },
            { id: 12, icon: "ph-phone-call", title: "Telephone (ఫోన్)", prompt: "Role: Customer Care. Context: Resolving an internet connection issue.", startMsg: "Thank you for calling Airtel. How may I assist you with your internet connection today?" },
            { id: 13, icon: "ph-house-line", title: "Neighbors (పొరుగువారు)", prompt: "Role: Neighbor. Context: Asking to lower music volume.", startMsg: "Hi there! Sorry to disturb, but could you please lower the music volume a bit?" },
            { id: 14, icon: "ph-chalkboard-teacher", title: "Teacher (టీచర్)", prompt: "Role: Class Teacher. Context: Discussing student's exam marks.", startMsg: "Good morning. I wanted to talk about your son's math marks. He needs to practice more." },
            { id: 15, icon: "ph-ticket", title: "Booking Tickets (టికెట్లు)", prompt: "Role: Ticket Clerk. Context: Booking movie tickets.", startMsg: "Which movie and which show time do you want tickets for?" },
            { id: 16, icon: "ph-bed", title: "Hotel Stay (హోటల్)", prompt: "Role: Receptionist. Context: Guest check-in process.", startMsg: "Welcome to Hotel Taj. Do you have a reservation under your name?" },
            { id: 17, icon: "ph-scissors", title: "Tailor (టైలర్)", prompt: "Role: Tailor. Context: Taking measurements for a dress.", startMsg: "Do you want the sleeves short or long? Let me take your measurements." },
            { id: 18, icon: "ph-wrench", title: "Mechanic (మెకానిక్)", prompt: "Role: Bike Mechanic. Context: Explaining brake failure.", startMsg: "Sir, your bike's rear brake is completely worn out. It needs replacement." },
            { id: 19, icon: "ph-pill", title: "Pharmacy (మందుల షాపు)", prompt: "Role: Pharmacist. Context: Giving medicines for a prescription.", startMsg: "Here are your medicines. Take this yellow tablet after dinner." },
            { id: 20, icon: "ph-siren", title: "Police Station (పోలీస్)", prompt: "Role: Police Inspector. Context: Taking a complaint about a lost phone.", startMsg: "Sit down. When and where did you lose your mobile phone? Tell me the details." },
            { id: 21, icon: "ph-airplane-tilt", title: "Airport (ఎయిర్‌పోర్ట్)", prompt: "Role: Check-in Staff. Context: Checking passport and luggage.", startMsg: "Good morning. May I have your passport and ticket please?" },
            { id: 22, icon: "ph-books", title: "Library (గ్రంథాలయం)", prompt: "Role: Librarian. Context: Issuing a book.", startMsg: "This book is due in 15 days. Please return it on time to avoid a fine." },
            { id: 23, icon: "ph-barbell", title: "Gym (జిమ్)", prompt: "Role: Gym Trainer. Context: Explaining a workout routine.", startMsg: "Okay, today we will focus on cardio. Start with 10 minutes on the treadmill." },
            { id: 24, icon: "ph-film-strip", title: "Movie Theater (సినిమా)", prompt: "Role: Friend. Context: Discussing a movie interval.", startMsg: "The first half was amazing, right? The hero's entry was superb!" },
            { id: 25, icon: "ph-cake", title: "Party (ఫంక్షన్)", prompt: "Role: Host. Context: Welcoming guests to a birthday party.", startMsg: "So glad you could make it! Please come in and have some cake." }
        ];

        // --- FULL 45 CLASSES CURRICULUM ---
        const CURRICULUM = [
            { id: 1, phase: "Phase I", title: "Class 01: Pronoun Roles", desc: "Subject (I, We) vs Object (Me, Us)" },
            { id: 2, phase: "Phase I", title: "Class 02: Self-Introduction", desc: "Name, family, profession, hobbies" },
            { id: 3, phase: "Phase I", title: "Class 03: Regular Verbs", desc: "Conjugation patterns (V1, V2, V3)" },
            { id: 4, phase: "Phase I", title: "Class 04: Irregular Verbs", desc: "High frequency irregulars" },
            { id: 5, phase: "Phase I", title: "Class 05: Simple Present", desc: "Habitual actions" },
            { id: 6, phase: "Phase I", title: "Class 06: Simple Present (Do/Does)", desc: "Questions & Negatives" },
            { id: 7, phase: "Phase I", title: "Class 07: WH-Questions", desc: "What, Why, Where, How" },
            { id: 8, phase: "Phase I", title: "Class 08: Simple Past", desc: "Completed actions (V2)" },
            { id: 9, phase: "Phase I", title: "Class 09: Simple Past (Did)", desc: "Past negatives and questions" },
            { id: 10, phase: "Phase I", title: "Class 10: WH-Questions (Did)", desc: "Detailed past inquiries" },
            { id: 11, phase: "Phase I", title: "Class 11: Simple Future", desc: "Will/Shall for future" },
            { id: 12, phase: "Phase I", title: "Class 12: WH-Questions (Future)", desc: "Future inquiries" },
            { id: 13, phase: "Phase II", title: "Class 13: Present Continuous", desc: "Am/Is/Are + V-ing" },
            { id: 14, phase: "Phase II", title: "Class 14: Past Continuous", desc: "Was/Were + V-ing" },
            { id: 15, phase: "Phase II", title: "Class 15: Future Continuous", desc: "Will be + V-ing" },
            { id: 16, phase: "Phase III", title: "Class 16: Can/Could", desc: "Ability & Permission" },
            { id: 17, phase: "Phase III", title: "Class 17: May/Might", desc: "Possibility & Uncertainty" },
            { id: 18, phase: "Phase III", title: "Class 18: Should", desc: "Advice & Duty" },
            { id: 19, phase: "Phase III", title: "Class 19: Must", desc: "Strong Obligation" },
            { id: 20, phase: "Phase III", title: "Class 20: Would", desc: "Past habits & Requests" },
            { id: 21, phase: "Phase IV", title: "Class 21: Have/Has", desc: "Possession" },
            { id: 22, phase: "Phase IV", title: "Class 22: Present Perfect", desc: "Recent past (Have + V3)" },
            { id: 23, phase: "Phase IV", title: "Class 23: Past Perfect", desc: "Action before action (Had + V3)" },
            { id: 24, phase: "Phase IV", title: "Class 24: Future Perfect", desc: "Completed by future" },
            { id: 25, phase: "Phase IV", title: "Class 25: Should have", desc: "Past unfulfilled duties" },
            { id: 26, phase: "Phase IV", title: "Class 26: May have", desc: "Past possibility" },
            { id: 27, phase: "Phase IV", title: "Class 27: Would have", desc: "Hypothetical past" },
            { id: 28, phase: "Phase IV", title: "Class 28: Past Review", desc: "Review of all past forms" },
            { id: 29, phase: "Phase IV", title: "Class 29: Present Perf. Cont.", desc: "Have been + V-ing" },
            { id: 30, phase: "Phase IV", title: "Class 30: Past Perf. Cont.", desc: "Had been + V-ing" },
            { id: 31, phase: "Phase IV", title: "Class 31: Future Perf. Cont.", desc: "Will have been + V-ing" },
            { id: 32, phase: "Phase IV", title: "Class 32: Modal Cont.", desc: "Should be + V-ing" },
            { id: 33, phase: "Phase IV", title: "Class 33: Should have been", desc: "Past continuous modals" },
            { id: 34, phase: "Phase IV", title: "Class 34: Would have been", desc: "Hypothetical continuous" },
            { id: 35, phase: "Phase IV", title: "Class 35: Review", desc: "Synthesis of perfects" },
            { id: 36, phase: "Phase V", title: "Class 36: Have to", desc: "External compulsion" },
            { id: 37, phase: "Phase V", title: "Class 37: Need/Dare", desc: "Necessity & Courage" },
            { id: 38, phase: "Phase V", title: "Class 38: Want/Wish", desc: "Desires & Preferences" },
            { id: 39, phase: "Phase V", title: "Class 39: Able to/Going to", desc: "Ability & Plans" },
            { id: 40, phase: "Phase V", title: "Class 40: Had to", desc: "Past compulsion" },
            { id: 41, phase: "Phase V", title: "Class 41: Used to", desc: "Past habits" },
            { id: 42, phase: "Phase VI", title: "Class 42: Tenses Matrix", desc: "The 12 Tenses Map" },
            { id: 43, phase: "Phase VI", title: "Class 43: Tenses Drill", desc: "Conjugation Practice" },
            { id: 44, phase: "Phase VI", title: "Class 44: Active/Passive", desc: "Voice Transformation" },
            { id: 45, phase: "Phase VI", title: "Class 45: Be with P.P. Form", desc: "Master key: Static states in modal contexts" }
        ];

        // --- AUDIO UTILS ---
        let currentlySpeakingText = null;

        const stopAudio = () => {
            window.speechSynthesis.cancel();
            currentlySpeakingText = null;
        };

        const speak = (text, lang) => {
            if (!window.speechSynthesis) return;

            if (window.speechSynthesis.speaking && text === currentlySpeakingText) {
                stopAudio(); return;
            }
            stopAudio(); // Stop previous
            
            const cleanText = text.replace(/[*_#`]/g, '').replace(/[\(\[].*?[\)\]]/g, '').replace(/-/g, ' ');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            if (lang === 'te') utterance.lang = 'te-IN';
            else if (lang === 'hi') utterance.lang = 'hi-IN';
            else utterance.lang = 'en-US';
            
            utterance.rate = 0.9;
            utterance.onstart = () => { currentlySpeakingText = text; };
            utterance.onend = () => { currentlySpeakingText = null; };

            window.speechSynthesis.speak(utterance);
        };

        // --- RATE LIMIT UTILS ---
        let lastRequestTimestamp = parseInt(localStorage.getItem('last_req_time') || '0');
        let requestCount = parseInt(localStorage.getItem('req_count_10m') || '0');
        let reqResetTime = parseInt(localStorage.getItem('req_reset_time') || Date.now().toString());
        
        const RATE_LIMIT_DELAY = 6000; 

        const checkRateLimit = async (onWait) => {
            const now = Date.now();
            const timeSinceLast = now - lastRequestTimestamp;
            if (timeSinceLast < RATE_LIMIT_DELAY) {
                const wait = RATE_LIMIT_DELAY - timeSinceLast;
                if(onWait) onWait(Math.ceil(wait/1000));
                await new Promise(r => setTimeout(r, wait));
            }
            if (now - reqResetTime > 10 * 60 * 1000) { // 10 min reset
                requestCount = 0;
                reqResetTime = now;
            }
            requestCount++;
            lastRequestTimestamp = Date.now();
            localStorage.setItem('last_req_time', lastRequestTimestamp.toString());
            localStorage.setItem('req_count_10m', requestCount.toString());
            localStorage.setItem('req_reset_time', reqResetTime.toString());
            return requestCount; 
        };

        // --- API GENERATION ---
        const generateLessonContent = async (apiKey, modelId, lessonInfo, qCount, onWait) => {
            const usage = await checkRateLimit(onWait);
            const prompt = `
                Create lesson: "${lessonInfo.title}".
                RULES:
                1. CONCEPTS: Provide **detailed** explanations in Telugu. Give **at least 2** examples for each.
                2. QUIZ QUESTIONS: Question in Telugu asking for translation (e.g., "అతను వెళ్లాడు' ని ఇంగ్లీష్‌లో ఏమంటారు?").
                3. QUIZ OPTIONS: **ONLY Target Language** (English/Hindi). NO Telugu options.
                4. QUIZ EXPLANATION: **Detailed Telugu explanation**, explaining *why* it's correct and *why* others are wrong.
                5. COUNT: Exactly ${qCount} English Qs, ${qCount} Hindi Qs.
                
                Return ONLY VALID JSON:
                {
                    "teluguTitle": "...",
                    "concepts": [{ "title": "...", "explanation": "Detailed Telugu...", "examples": [{ "te": "...", "en": "...", "hi": "..." }, { "te": "...", "en": "...", "hi": "..." }] }],
                    "quizEnglish": [{ "question": "...", "options": ["En1", "En2"], "correct": 0, "explanation": "Detailed Telugu expl..." }],
                    "quizHindi": [{ "question": "...", "options": ["Hi1", "Hi2"], "correct": 0, "explanation": "Detailed Telugu expl..." }]
                }
            `;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (response.status === 429) throw new Error("Rate Limit (429). Wait 10s.");
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (e) { throw e; }
        };

        const callGeminiChat = async (apiKey, modelId, scenarioPrompt, userText, chatLang, onWait) => {
            await checkRateLimit(onWait);
            const targetLang = chatLang === 'en' ? 'English' : 'Hindi';
            const prompt = `
                Role-play Persona: ${scenarioPrompt}.
                Lang: ${targetLang}. User: "${userText}".
                RULES:
                1. Reply in a natural, detailed, and conversational way (2-3 sentences) in ${targetLang}.
                2. Provide a clear Telugu translation of your reply.
                3. If user made grammar mistake: Provide a **detailed, step-by-step correction in Telugu**. Explain *what* was wrong and *how* to say it correctly (e.g., "మీరు 'I go' అన్నారు, కానీ 'I am going' అనాలి, ఎందుకంటే...").
                4. If no mistake: "feedback" must be null.
                
                Output JSON: { "reply": "...", "te_translation": "...", "feedback": "..." }
            `;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (e) { return { reply: "Error.", te_translation: "లోపం.", feedback: null }; }
        };

        // --- MAIN APP ---
        const App = () => {
            const [view, setView] = useState('home'); 
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [modelId, setModelId] = useState(localStorage.getItem('gemini_model_id') || 'gemini-2.5-flash');
            const [showSettings, setShowSettings] = useState(false);
            const [usageLevel, setUsageLevel] = useState(0);
            
            const [selectedLesson, setSelectedLesson] = useState(null);
            const [lessonData, setLessonData] = useState(null);
            const [prefLang, setPrefLang] = useState('en');
            const [prefQCount, setPrefQCount] = useState(5);
            const [quizState, setQuizState] = useState({ index: 0, score: 0, answered: false, selected: null, isCorrect: false, history: [] });
            const [searchTerm, setSearchTerm] = useState('');

            const [activeScenario, setActiveScenario] = useState(null);
            const [chatLang, setChatLang] = useState('en'); 
            const [messages, setMessages] = useState([]);
            const [inputObj, setInputObj] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            
            const [loading, setLoading] = useState(false);
            const [waitTime, setWaitTime] = useState(0);
            const [error, setError] = useState(null);
            const chatContainerRef = useRef(null);

            useEffect(() => { if (waitTime > 0) { const t = setTimeout(() => setWaitTime(w => w - 1), 1000); return () => clearTimeout(t); } }, [waitTime]);
            useEffect(() => { if (chatContainerRef.current) chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight; }, [messages]);
            useEffect(() => { setUsageLevel(parseInt(localStorage.getItem('req_count_10m') || '0')); }, [view]);

            const filteredCurriculum = useMemo(() => CURRICULUM.filter(l => l.title.toLowerCase().includes(searchTerm.toLowerCase())), [searchTerm]);

            const saveSettings = () => {
                localStorage.setItem('gemini_api_key', apiKey);
                localStorage.setItem('gemini_model_id', modelId);
                setShowSettings(false);
            };

            const handleStartLesson = async (lesson, forceRefresh = false) => {
                if (!apiKey) { setShowSettings(true); return; }
                setSelectedLesson(lesson);
                setLoading(true); setWaitTime(0); setError(null);
                try {
                    const cacheKey = `speakpro_v7_l${lesson.id}_q${prefQCount}`;
                    let data = localStorage.getItem(cacheKey);
                    if (!forceRefresh && data) {
                        await new Promise(r => setTimeout(r, 300));
                        data = JSON.parse(data);
                    } else {
                        data = await generateLessonContent(apiKey, modelId, lesson, prefQCount, (t) => setWaitTime(t));
                        localStorage.setItem(cacheKey, JSON.stringify(data));
                        setUsageLevel(prev => prev + 1);
                    }
                    if (!data.concepts) throw new Error("AI Error. Refresh.");
                    setLessonData(data);
                    setView('lesson');
                } catch (e) { setError(e.message); } finally { setLoading(false); }
            };
            
            const startQuiz = () => {
                setQuizState({ index: 0, score: 0, answered: false, selected: null, isCorrect: false, history: [] });
                setView('quiz');
            };

            const handleStartChat = (scenario) => {
                setActiveScenario(scenario);
                let greeting = chatLang === 'en' ? scenario.startMsg : "नमस्ते! मैं आपकी कैसे मदद कर सकता हूँ?";
                if (chatLang === 'en') greeting = scenario.startMsg;
                setMessages([{ role: 'ai', text: greeting, translation: "సంభాషణ ప్రారంభం...", feedback: null }]);
                setView('chat');
            };

            const handleSendChat = async () => {
                if (!inputObj.trim() || !apiKey) return;
                const userText = inputObj;
                setInputObj('');
                setMessages(p => [...p, { role: 'user', text: userText }]);
                setLoading(true);
                try {
                    const data = await callGeminiChat(apiKey, modelId, activeScenario.prompt, userText, chatLang, (t) => setWaitTime(t));
                    setMessages(p => [...p, { role: 'ai', text: data.reply, translation: data.te_translation, feedback: data.feedback }]);
                    speak(data.reply, chatLang);
                    setUsageLevel(prev => prev + 1);
                } catch (e) { alert(e.message); } finally { setLoading(false); }
            };

            const startListening = () => {
                if (!('webkitSpeechRecognition' in window)) { alert("No voice support."); return; }
                const rec = new window.webkitSpeechRecognition();
                rec.lang = chatLang === 'en' ? 'en-US' : 'hi-IN';
                rec.onstart = () => setIsRecording(true);
                rec.onend = () => setIsRecording(false);
                rec.onresult = (e) => setInputObj(e.results[0][0].transcript);
                rec.start();
            };

            // --- LOADING RENDER ---
            if (loading && view !== 'chat') return (
                <div className="h-screen flex flex-col items-center justify-center glass-panel p-6 text-center">
                    {waitTime > 0 ? <div className="text-4xl font-bold text-blue-600 mb-2">{waitTime}s</div> : <i className="ph ph-spinner text-4xl text-blue-600 animate-spin-slow mb-4"></i>}
                    <p className="text-gray-600 text-sm font-semibold">{waitTime > 0 ? "Safety Wait..." : "Generating..."}</p>
                    {error && <div className="mt-4 text-red-500 text-xs bg-red-50 p-2 rounded">{error} <button onClick={() => {setError(null); handleStartLesson(selectedLesson, true)}} className="underline font-bold">Retry</button></div>}
                </div>
            );

            // 1. HOME
            if (view === 'home') return (
                <div className="min-h-screen p-4 pb-10 relative">
                    <div className="glass-panel rounded-full h-2 mb-6 overflow-hidden">
                        <div className="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all duration-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]" style={{width: `${Math.min(usageLevel * 10, 100)}%`}}></div>
                    </div>
                    <div className="flex justify-between items-center mb-8 relative z-10">
                        <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2 drop-shadow-sm"><i className="ph ph-student text-blue-600 bg-white/50 p-1 rounded-lg"></i> SpeakPro Glass</h1>
                        <div className="flex gap-3">
                             <button onClick={stopAudio} className="glass-card p-2.5 rounded-full text-red-500 hover:bg-white active:scale-95 transition-all"><i className="ph ph-speaker-slash text-xl"></i></button>
                             <button onClick={() => setShowSettings(true)} className={`glass-card p-2.5 rounded-full hover:bg-white active:scale-95 transition-all ${apiKey ? 'text-gray-700' : 'text-amber-600 animate-bounce'}`}><i className="ph ph-gear text-xl"></i></button>
                        </div>
                    </div>
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-slide-in">
                            <div className="glass-panel p-6 rounded-2xl w-full max-w-sm relative">
                                <button onClick={() => setShowSettings(false)} className="absolute top-3 right-3 text-gray-500"><i className="ph ph-x text-lg"></i></button>
                                <h3 className="font-bold text-lg mb-4 text-slate-800">Settings</h3>
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="Paste API Key" className="glass-input w-full p-3 rounded-xl text-sm mb-3 text-slate-800 placeholder-gray-500 outline-none focus:ring-2 focus:ring-blue-400" />
                                <input type="text" value={modelId} onChange={e => setModelId(e.target.value)} placeholder="Model Name" className="glass-input w-full p-3 rounded-xl text-sm mb-4 text-slate-800 placeholder-gray-500 outline-none focus:ring-2 focus:ring-blue-400" />
                                <button onClick={saveSettings} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-colors">Save & Close</button>
                            </div>
                        </div>
                    )}
                    <div className="grid gap-5">
                        <button onClick={() => setView('course_list')} className="glass-card p-6 rounded-3xl text-left relative overflow-hidden group active:scale-95 transition-transform hover:bg-white/80">
                             <div className="absolute top-0 right-0 bg-blue-500 w-24 h-24 rounded-bl-full -mr-10 -mt-10 opacity-20"></div>
                             <i className="ph ph-book-open text-4xl text-blue-700 mb-3 drop-shadow-sm"></i>
                             <h2 className="text-xl font-bold text-slate-800">45-Day Course</h2>
                             <p className="text-slate-600 text-sm mt-1 font-medium">Systematic Learning</p>
                        </button>
                        <button onClick={() => setView('roleplay_list')} className="glass-card p-6 rounded-3xl text-left relative overflow-hidden group active:scale-95 transition-transform hover:bg-white/80">
                             <div className="absolute top-0 right-0 bg-emerald-500 w-24 h-24 rounded-bl-full -mr-10 -mt-10 opacity-20"></div>
                             <i className="ph ph-chats-circle text-4xl text-emerald-700 mb-3 drop-shadow-sm"></i>
                             <h2 className="text-xl font-bold text-slate-800">Role Play</h2>
                             <p className="text-slate-600 text-sm mt-1 font-medium">25 Real Scenarios</p>
                        </button>
                    </div>
                </div>
            );

            // 2. COURSE LIST
            if (view === 'course_list') return (
                <div className="min-h-screen p-4 pb-10">
                    <div className="glass-panel sticky top-4 p-3 rounded-xl mb-6 z-20 flex items-center justify-between">
                        <button onClick={() => setView('home')} className="text-gray-600 p-2 hover:bg-white/50 rounded-full"><i className="ph ph-arrow-left text-xl"></i></button>
                        <h2 className="font-bold text-lg text-slate-800">Select Class</h2>
                        <button onClick={stopAudio} className="text-red-500 p-2 hover:bg-white/50 rounded-full"><i className="ph ph-speaker-slash text-xl"></i></button>
                    </div>
                    <div className="glass-card p-4 rounded-2xl mb-4">
                        <div className="flex gap-2 mb-3">
                            <button onClick={() => setPrefLang('en')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm ${prefLang === 'en' ? 'bg-blue-600 text-white' : 'bg-white/60 text-gray-600'}`}>English</button>
                            <button onClick={() => setPrefLang('hi')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm ${prefLang === 'hi' ? 'bg-orange-600 text-white' : 'bg-white/60 text-gray-600'}`}>Hindi</button>
                        </div>
                        <div className="flex gap-2">
                            {[3, 5, 10].map(n => <button key={n} onClick={() => setPrefQCount(n)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm ${prefQCount === n ? 'bg-slate-800 text-white' : 'bg-white/60 text-gray-600'}`}>{n} Qs</button>)}
                        </div>
                    </div>
                    <div className="space-y-3">
                        {filteredCurriculum.map(l => (
                            <button key={l.id} onClick={() => handleStartLesson(l)} className="w-full glass-card p-4 rounded-2xl flex items-center justify-between active:scale-95 transition-all hover:bg-white/80">
                                <div className="text-left"><span className="text-[10px] bg-blue-100/80 text-blue-700 px-2 py-1 rounded font-bold backdrop-blur-sm">Class {l.id}</span><h3 className="font-bold text-slate-800 text-sm mt-1">{l.title.split(':')[1]}</h3></div>
                                <i className="ph ph-caret-right text-gray-500"></i>
                            </button>
                        ))}
                    </div>
                </div>
            );

            // 3. LESSON VIEW
            if (view === 'lesson') return (
                <div className="min-h-screen pb-24">
                    <div className="glass-panel sticky top-0 z-20 p-4 flex justify-between items-center border-b-0 shadow-lg backdrop-blur-xl">
                        <button onClick={() => setView('course_list')} className="text-gray-600 p-2 hover:bg-white/50 rounded-full"><i className="ph ph-arrow-left text-xl"></i></button>
                        <span className={`text-xs font-bold px-3 py-1 rounded-full backdrop-blur-sm ${prefLang === 'en' ? 'bg-blue-100/80 text-blue-800' : 'bg-orange-100/80 text-orange-800'}`}>{prefLang === 'en' ? 'English' : 'Hindi'} Mode</span>
                        <div className="flex gap-2">
                            <button onClick={stopAudio} className="p-2 rounded-full bg-red-50/80 text-red-500 hover:bg-red-100"><i className="ph ph-speaker-slash text-xl"></i></button>
                            <button onClick={() => { if(confirm('Refresh?')) handleStartLesson(selectedLesson, true); }} className="p-2 rounded-full bg-blue-50/80 text-blue-500 hover:bg-blue-100"><i className="ph ph-arrows-clockwise text-xl"></i></button>
                        </div>
                    </div>
                    <div className="p-4 space-y-6 animate-slide-in">
                        <div className="text-center my-2 glass-card p-3 rounded-xl inline-block w-full"><h3 className="text-lg font-telugu font-bold text-slate-800 leading-snug">{lessonData.teluguTitle}</h3></div>
                        {lessonData.concepts.map((c, i) => (
                            <div key={i} className="glass-card p-5 rounded-3xl">
                                <h3 className="font-bold text-slate-800 mb-3 flex items-center gap-2 text-sm uppercase tracking-wide"><i className="ph ph-sparkle text-yellow-500 drop-shadow-sm"></i> {c.title}</h3>
                                <div className="bg-white/60 p-4 rounded-xl mb-4 relative group border border-white/50 shadow-inner">
                                    <p className="text-slate-800 text-sm font-telugu leading-relaxed pr-8 font-medium">{c.explanation}</p>
                                    <button onClick={() => speak(c.explanation, 'te')} className="absolute top-3 right-3 text-slate-400 hover:text-blue-600 bg-white/80 p-1.5 rounded-full shadow-sm"><i className="ph ph-speaker-high"></i></button>
                                </div>
                                <div className="space-y-3">
                                    {c.examples.map((ex, j) => (
                                        <div key={j} className={`border-l-4 pl-4 py-2 ${prefLang === 'en' ? 'border-blue-500' : 'border-orange-500'} bg-white/40 rounded-r-xl backdrop-blur-sm`}>
                                            <div className="flex justify-between items-start mb-1">
                                                <span className="text-xs text-slate-600 font-telugu font-semibold">{ex.te}</span>
                                                <button onClick={() => speak(ex.te, 'te')} className="text-gray-400 hover:text-gray-700"><i className="ph ph-speaker-simple-high text-xs"></i></button>
                                            </div>
                                            {prefLang === 'en' ? (
                                                <div className="flex justify-between items-center">
                                                    <span className="font-bold text-blue-800 text-sm">{ex.en}</span>
                                                    <button onClick={() => speak(ex.en, 'en')} className="text-blue-400 hover:text-blue-700"><i className="ph ph-speaker-high"></i></button>
                                                </div>
                                            ) : (
                                                <div className="flex justify-between items-center">
                                                    <span className="font-bold text-orange-800 text-sm">{ex.hi}</span>
                                                    <button onClick={() => speak(ex.hi, 'hi')} className="text-orange-400 hover:text-orange-700"><i className="ph ph-speaker-high"></i></button>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 p-4 glass-panel border-t-0 flex justify-center z-20"><button onClick={() => { setQuizState({ index: 0, score: 0, answered: false, selected: null, isCorrect: false, history: [] }); setView('quiz'); }} className={`w-full max-w-md text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 flex items-center justify-center gap-2 ${prefLang === 'en' ? 'bg-blue-600/90 hover:bg-blue-600' : 'bg-orange-600/90 hover:bg-orange-600'} backdrop-blur-md`}>
                            Start Quiz ({prefQCount} Qs) <i className="ph ph-caret-right"></i>
                        </button>
                    </div>
                </div>
            );

            // 4. QUIZ VIEW
            if (view === 'quiz') {
                const currentQuiz = prefLang === 'en' ? lessonData.quizEnglish : lessonData.quizHindi;
                const q = currentQuiz[quizState.index];
                const color = prefLang === 'en' ? 'blue' : 'orange';
                if (!q) { setTimeout(() => setView('result'), 100); return null; }

                return (
                    <div className={`min-h-screen flex flex-col relative`}>
                         <div className={`absolute inset-0 bg-${color}-500/10 backdrop-blur-sm pointer-events-none`}></div>
                        <div className="p-6 flex justify-between items-center relative z-10">
                            <button onClick={() => setView('lesson')} className={`p-2 rounded-full glass-card text-${color}-700`}><i className="ph ph-x"></i></button>
                            <div className={`px-3 py-1 rounded-full glass-card text-${color}-800 text-xs font-bold`}>Q {quizState.index + 1} / {currentQuiz.length}</div>
                            <button onClick={stopAudio} className={`text-${color}-700 p-2 glass-card rounded-full`}><i className="ph ph-speaker-slash text-xl"></i></button>
                        </div>
                        <div className="flex-1 px-6 flex flex-col justify-center pb-20 relative z-10">
                            <div className="glass-panel p-8 rounded-3xl mb-6 text-center relative">
                                <h2 className="text-xl font-bold text-slate-800 font-telugu leading-relaxed">{q.question}</h2>
                                <button onClick={() => speak(q.question, 'te')} className="absolute top-4 right-4 text-gray-400 hover:text-blue-600"><i className="ph ph-speaker-high"></i></button>
                            </div>
                            <div className="space-y-3">
                                {q.options.map((opt, idx) => {
                                    let style = "glass-card text-slate-700 hover:bg-white/70";
                                    if (quizState.answered) {
                                        if (idx === q.correct) { style = "bg-green-500 text-white border-green-500 shadow-lg"; }
                                        else if (idx === quizState.selected) { style = "bg-red-500 text-white border-red-500 shadow-lg"; }
                                        else { style = "glass-card opacity-50"; }
                                    }
                                    return (
                                        <button key={idx} onClick={() => { 
                                            if(quizState.answered) return; 
                                            const isCorrect = idx === q.correct;
                                            const newHistory = [...quizState.history, { question: q.question, correctAns: q.options[q.correct], userAns: opt, isCorrect }];
                                            setQuizState({ ...quizState, answered: true, selected: idx, isCorrect, score: isCorrect ? quizState.score + 1 : quizState.score, history: newHistory }); 
                                        }} disabled={quizState.answered} className={`w-full p-4 rounded-xl border font-semibold transition-all flex justify-between items-center active:scale-98 ${style}`}>
                                            <span>{opt}</span>
                                        </button>
                                    )
                                })}
                            </div>
                            {quizState.answered && (
                                <div className="mt-6 animate-slide-in">
                                    <div className={`glass-panel p-4 rounded-2xl border-l-4 ${quizState.isCorrect ? 'border-green-500' : 'border-red-500'} mb-4 text-sm font-telugu text-slate-800 flex justify-between gap-2`}>
                                        <span className="flex-1 leading-relaxed">{q.explanation}</span>
                                        <button onClick={() => speak(q.explanation, 'te')} className="text-blue-600 shrink-0"><i className="ph ph-speaker-high"></i></button>
                                    </div>
                                    <button onClick={() => { if (quizState.index < currentQuiz.length - 1) setQuizState({ ...quizState, index: quizState.index + 1, answered: false, selected: null, isCorrect: false, history: quizState.history }); else setView('result'); }} className={`w-full bg-${color}-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 hover:bg-${color}-700 transition-colors`}>Next <i className="ph ph-arrow-right"></i></button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // 5. RESULT VIEW
            if (view === 'result') {
                const colorClass = prefLang === 'en' ? 'blue' : 'orange';
                const total = prefLang === 'en' ? lessonData.quizEnglish.length : lessonData.quizHindi.length;
                const percentage = Math.round((quizState.score / total) * 100);
                const passed = percentage >= 70;
                
                return (
                    <div className="min-h-screen p-6 pb-20 flex flex-col items-center justify-center">
                         <div className="glass-panel w-full max-w-lg p-8 rounded-3xl text-center relative overflow-hidden">
                             {passed && <div className="absolute inset-0 bg-yellow-400/10 z-0 animate-pulse"></div>}
                            <div className="relative z-10">
                                {passed ? <i className="ph ph-medal text-yellow-400 text-8xl mb-4 animate-bounce drop-shadow-md"></i> : <i className="ph ph-smiley-sad text-gray-400 text-8xl mb-4"></i>}
                                <h2 className="text-3xl font-bold text-slate-800 mb-2">{passed ? "Excellent!" : "Keep Trying"}</h2>
                                <p className="text-slate-600 text-lg font-bold">{percentage}% Score</p>
                                <p className="text-sm text-slate-500 mb-6">{quizState.score} out of {total} Correct</p>
                            </div>
                            
                            <div className="bg-white/50 rounded-2xl p-4 mb-6 text-left max-h-60 overflow-y-auto no-scrollbar">
                                <h3 className="font-bold text-slate-700 mb-3 text-sm uppercase sticky top-0 bg-white/80 p-2 rounded-lg backdrop-blur-sm">Review Answers</h3>
                                <div className="space-y-3">
                                    {quizState.history.length === 0 ? <p className="text-sm text-gray-500">No questions answered yet.</p> : 
                                        quizState.history.map((item, i) => (
                                        <div key={i} className={`flex gap-3 items-start text-sm border-b border-gray-300/50 pb-2 last:border-0 ${item.isCorrect ? 'opacity-60' : ''}`}>
                                            {item.isCorrect ? <i className="ph ph-check-circle text-green-600 text-lg shrink-0"></i> : <i className="ph ph-x-circle text-red-500 text-lg shrink-0"></i>}
                                            <div>
                                                <p className="font-telugu text-slate-800 font-medium">{item.question}</p>
                                                {!item.isCorrect && <p className="text-xs mt-1"><span className="text-red-600 line-through mr-2">{item.userAns}</span><span className="text-green-700 font-bold">{item.correctAns}</span></p>}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
    
                            <div className="flex gap-3 justify-center z-10">
                                <button onClick={() => { setView('lesson'); }} className="flex-1 bg-gray-100/80 hover:bg-white text-slate-700 font-bold py-3 px-6 rounded-xl backdrop-blur-md transition-all">Retry</button>
                                {passed ? (
                                    <button onClick={() => setView('course_list')} className="flex-[2] bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-green-700 transition-all">Next Class <i className="ph ph-lock-open"></i></button>
                                ) : (
                                    <button onClick={() => setView('course_list')} className="flex-[2] bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition-all">Course Menu</button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // 6. ROLE PLAY LIST
            if (view === 'roleplay_list') return (
                <div className="min-h-screen p-4 pb-safe">
                     <div className="glass-panel sticky top-4 z-20 py-2 px-3 rounded-xl mb-6 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            <button onClick={() => setView('home')} className="text-gray-600 p-2 hover:bg-white/50 rounded-full"><i className="ph ph-arrow-left text-xl"></i></button>
                            <h2 className="font-bold text-lg text-slate-800">Choose Scenario</h2>
                        </div>
                        <div className="flex bg-white/60 p-1 rounded-lg shadow-inner ml-auto border border-white/40">
                            <button onClick={() => setChatLang('en')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${chatLang === 'en' ? 'bg-blue-100/80 text-blue-600' : 'text-gray-500'}`}>ENG</button>
                            <button onClick={() => setChatLang('hi')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${chatLang === 'hi' ? 'bg-orange-100/80 text-orange-600' : 'text-gray-500'}`}>HIN</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        {SCENARIOS.map(s => (
                            <button key={s.id} onClick={() => handleStartChat(s)} className="glass-card p-4 rounded-2xl text-center active:scale-95 transition-all hover:bg-white/80">
                                <i className={`ph ${s.icon} text-3xl text-blue-600 mb-2 drop-shadow-sm`}></i>
                                <h3 className="font-bold text-slate-700 text-xs leading-tight font-telugu">{s.title}</h3>
                            </button>
                        ))}
                    </div>
                </div>
            );

            // 7. CHAT
            if (view === 'chat') return (
                <div className="min-h-screen flex flex-col relative">
                     <div className="absolute inset-0 bg-indigo-500/5 pointer-events-none backdrop-blur-sm"></div>
                    <div className="glass-panel p-3 flex items-center gap-3 z-20 justify-between rounded-b-2xl shadow-md">
                        <div className="flex items-center gap-3">
                             <button onClick={() => setView('roleplay_list')} className="text-gray-600 p-1"><i className="ph ph-arrow-left text-xl"></i></button>
                             <div><h2 className="font-bold text-slate-800 text-sm font-telugu">{activeScenario.title}</h2><p className="text-[10px] text-slate-500 font-bold uppercase">{chatLang === 'en' ? 'English' : 'Hindi'} Mode</p></div>
                        </div>
                        <button onClick={stopAudio} className="text-red-500 p-2 bg-red-50/50 rounded-full hover:bg-red-100"><i className="ph ph-speaker-slash text-xl"></i></button>
                    </div>
                    <div ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 space-y-6 relative z-10">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.role === 'user' ? 'items-end' : 'items-start'}`}>
                                <div className={`max-w-[85%] p-3.5 text-sm relative group shadow-md backdrop-blur-md ${m.role === 'user' ? 'bubble-user' : 'glass-bubble-ai'}`}>{m.text}{m.role === 'ai' && <button onClick={() => speak(m.text, chatLang)} className="absolute -right-8 top-1 text-gray-500 hover:text-blue-600 p-1 bg-white/60 rounded-full shadow-sm"><i className="ph ph-speaker-high text-base"></i></button>}</div>
                                {m.role === 'ai' && (
                                    <div className="max-w-[85%] mt-1 space-y-1">
                                        <div className="text-xs text-slate-600 font-telugu bg-white/60 px-2 py-1 rounded-md border border-white/50 shadow-sm backdrop-blur-md">
                                            {m.translation}
                                        </div>
                                        {m.feedback && (
                                            <div className="feedback-box p-3 rounded-xl text-xs font-telugu shadow-sm mt-2">
                                                <strong className="block mb-1 flex items-center gap-1 text-amber-800"><i className="ph ph-warning-circle"></i> సవరణ (Correction):</strong>
                                                {m.feedback}
                                                <button onClick={() => speak(m.feedback, 'te')} className="ml-2 text-amber-700 hover:text-amber-900"><i className="ph ph-speaker-high"></i></button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                        {loading && <div className="flex justify-start"><div className="glass-card p-3 rounded-xl rounded-bl-none flex gap-1 shadow-sm"><div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></div><div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce delay-75"></div><div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce delay-150"></div></div></div>}
                    </div>
                    <div className="glass-panel p-3 border-t border-white/30 flex items-center gap-2 z-20">
                        <button onClick={startListening} disabled={waitTime > 0 || loading} className={`p-3 rounded-full transition-all flex-shrink-0 shadow-sm border border-white/50 ${isRecording ? 'bg-red-500 text-white animate-pulse-ring' : 'bg-white/60 text-gray-600 hover:bg-white'}`}><i className={`ph ${isRecording ? 'ph-microphone-slash' : 'ph-microphone'} text-xl`}></i></button>
                        <input type="text" value={inputObj} onChange={(e) => setInputObj(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSendChat()} placeholder={waitTime > 0 ? `Wait ${waitTime}s...` : isRecording ? "Listening..." : "Type message..."} className="flex-1 glass-input border-transparent rounded-full px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 placeholder-slate-500 text-slate-800" disabled={waitTime > 0 || loading} />
                        <button onClick={handleSendChat} disabled={!inputObj.trim() || waitTime > 0 || loading} className={`p-3 rounded-full flex-shrink-0 shadow-lg border border-white/20 ${!inputObj.trim() || waitTime > 0 ? 'bg-gray-200/50 text-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 active:scale-90'} transition-all`}><i className="ph ph-paper-plane-right text-xl"></i></button>
                    </div>
                </div>
            );

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // --- PWA SERVICE WORKER REGISTRATION ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker Registered!', reg.scope))
                    .catch(err => console.log('Service Worker Failed:', err));
            });
        }
    </script>
</body>
</html>

