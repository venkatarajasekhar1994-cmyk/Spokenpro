<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="SpeakPro - Learn English & Hindi through conversation">
    <title>SpeakPro - Glass PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="1000094592.jpg">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&family=Ramabhadra&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { 
            font-family: 'Open Sans', sans-serif; 
            background-color: #f8fafc; /* slate-50 */
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.3s ease;
        }

        /* Glass Utility Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        .glass-bubble-ai {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: #020617; /* slate-950 - PURE BLACK TEXT FIX */
            border-radius: 18px 18px 18px 0;
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .font-telugu { font-family: 'Ramabhadra', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .bubble-user { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border-radius: 18px 18px 0 18px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .feedback-box { background: rgba(255, 251, 235, 0.9); border-left: 4px solid #f59e0b; color: #92400e; font-size: 0.85rem; backdrop-filter: blur(4px); }
        
        img[src*="placehold.co"] {
            background-color: #e2e8f0; color: #475569; object-fit: cover;
            text-align: center; font-size: 12px; font-family: 'Open Sans', sans-serif;
        }

        /* --- DARK MODE STYLES --- */
        .dark body {
            background-color: #0f172a; /* slate-900 */
        }
        .dark .glass-panel {
            background: rgba(26, 38, 58, 0.75); 
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .dark .glass-card {
            background: rgba(26, 38, 58, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.4);
        }
        .dark .glass-bubble-ai {
            background: rgba(43, 56, 78, 0.85);
            border: 1px solid rgba(63, 80, 102, 1);
            color: #f1f5f9; /* slate-100 */
        }
        .dark .glass-input {
            background: rgba(43, 56, 78, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.5);
            color: white;
        }
        .dark .feedback-box {
            background: rgba(60, 44, 7, 0.9);
            border-left: 4px solid #b45309;
            color: #fef9c3; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error: error }; }
            componentDidCatch(error, errorInfo) { this.setState({ errorInfo: errorInfo }); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '20px', height: '100vh', overflowY: 'auto' }} className="bg-white text-red-700 dark:bg-slate-900 dark:text-red-400">
                            <h1 className="text-xl font-bold">App Error</h1>
                            <p className="mt-2 text-black dark:text-slate-200">Please reload. If error persists, check API Key.</p>
                            <pre style={{ color: 'black', background: '#f3f4f6', padding: '10px', borderRadius: '5px', marginTop: '15px', whiteSpace: 'pre-wrap', wordWrap: 'break-word', border: '1px solid #e5e7eb' }} className="text-black bg-slate-100 dark:text-slate-200 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                                <strong>Error: {this.state.error && this.state.error.toString()}</strong>
                            </pre>
                            <button onClick={() => window.location.reload()} className="mt-4 bg-blue-600 text-white p-2 rounded">Reload App</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        const SCENARIOS = [
            { id: 1, icon: "ph-users-three", title: "Family (కుటుంబం)", prompt: "Role: Caring Mother. Context: Asking child about school and lunch.", startMsg: "Hello my dear! How was school today? Did you eat your lunch?" },
            { id: 2, icon: "ph-confetti", title: "Friends (స్నేహితులు)", prompt: "Role: Best Friend. Context: Planning a movie for the weekend.", startMsg: "Hey buddy! Long time no see. Are we going to the movie this Saturday?" },
            { id: 3, icon: "ph-briefcase", title: "Colleagues (ఆఫీస్)", prompt: "Role: Project Manager. Context: Asking about the project deadline status.", startMsg: "Hi, good morning. Have you completed the report I asked for yesterday?" },
            { id: 4, icon: "ph-carrot", title: "Vegetable Market (కూరగాయలు)", prompt: "Role: Vegetable Vendor. Context: Selling fresh tomatoes and negotiating price.", startMsg: "Madam! Fresh tomatoes just arrived. Only 40 rupees a kilo. How much do you need?" },
            { id: 5, icon: "ph-stethoscope", title: "Doctor (డాక్టర్)", prompt: "Role: Doctor. Context: Diagnosing fever and cold symptoms.", startMsg: "Hello. Please sit down. What seems to be the problem today?" },
            { id: 6, icon: "ph-fork-knife", title: "Restaurant (రెస్టారెంట్)", prompt: "Role: Waiter. Context: Taking order for dinner.", startMsg: "Good evening sir/madam. Here is the menu. Would you like to start with some soup?" },
            { id: 7, icon: "ph-user-focus", title: "Job Interview (ఇంటర్వ్యూ)", prompt: "Role: HR Manager. Context: Interviewing for a software developer role.", startMsg: "Welcome. Please introduce yourself and tell me about your experience." },
            { id: 8, icon: "ph-map-pin", title: "Asking Directions (చిరునామా)", prompt: "Role: Local Stranger. Context: Helping someone find the post office.", startMsg: "Excuse me? Are you lost? Where do you want to go?" },
            { id: 9, icon: "ph-bus", title: "Bus Station (బస్)", prompt: "Role: Bus Conductor. Context: Asking for tickets and destination.", startMsg: "Ticket! Ticket! Where to? Move to the back please." },
            { id: 10, icon: "ph-bank", title: "Bank (బ్యాంకు)", prompt: "Role: Bank Manager. Context: Discussing a personal loan application.", startMsg: "Good morning. You wanted to apply for a personal loan, right? Do you have your ID proof?" },
            { id: 11, icon: "ph-shopping-bag", title: "Shopping Mall (షాపింగ్)", prompt: "Role: Sales Executive. Context: Helping customer choose a shirt.", startMsg: "Hello sir. Looking for formal shirts or casuals? We have a new collection." },
            { id: 12, icon: "ph-phone-call", title: "Telephone (ఫోన్)", prompt: "Role: Customer Care. Context: Resolving an internet connection issue.", startMsg: "Thank you for calling Airtel. How may I assist you with your internet connection today?" },
            { id: 13, icon: "ph-house-line", title: "Neighbors (పొరుగువారు)", prompt: "Role: Neighbor. Context: Asking to lower music volume.", startMsg: "Hi there! Sorry to disturb, but could you please lower the music volume a bit?" },
            { id: 14, icon: "ph-chalkboard-teacher", title: "Teacher (టీచర్)", prompt: "Role: Class Teacher. Context: Discussing student's exam marks.", startMsg: "Good morning. I wanted to talk about your son's math marks. He needs to practice more." },
            { id: 15, icon: "ph-ticket", title: "Booking Tickets (టికెట్లు)", prompt: "Role: Ticket Clerk. Context: Booking movie tickets.", startMsg: "Which movie and which show time do you want tickets for?" },
            { id: 16, icon: "ph-bed", title: "Hotel Stay (హోటల్)", prompt: "Role: Receptionist. Context: Guest check-in process.", startMsg: "Welcome to Hotel Taj. Do you have a reservation under your name?" },
            { id: 17, icon: "ph-scissors", title: "Tailor (టైలర్)", prompt: "Role: Tailor. Context: Taking measurements for a dress.", startMsg: "Do you want the sleeves short or long? Let me take your measurements." },
            { id: 18, icon: "ph-wrench", title: "Mechanic (మెకానిక్)", prompt: "Role: Bike Mechanic. Context: Explaining brake failure.", startMsg: "Sir, your bike's rear brake is completely worn out. It needs replacement." },
            { id: 19, icon: "ph-pill", title: "Pharmacy (మందుల షాపు)", prompt: "Role: Pharmacist. Context: Giving medicines for a prescription.", startMsg: "Here are your medicines. Take this yellow tablet after dinner." },
            { id: 20, icon: "ph-siren", title: "Police Station (పోలీస్)", prompt: "Role: Police Inspector. Context: Taking a complaint about a lost phone.", startMsg: "Sit down. When and where did you lose your mobile phone? Tell me the details." },
            { id: 21, icon: "ph-airplane-tilt", title: "Airport (ఎయిర్‌పోర్ట్)", prompt: "Role: Check-in Staff. Context: Checking passport and luggage.", startMsg: "Good morning. May I have your passport and ticket please?" },
            { id: 22, icon: "ph-books", title: "Library (గ్రంథాలయం)", prompt: "Role: Librarian. Context: Issuing a book.", startMsg: "This book is due in 15 days. Please return it on time to avoid a fine." },
            { id: 23, icon: "ph-barbell", title: "Gym (జిమ్)", prompt: "Role: Gym Trainer. Context: Explaining a workout routine.", startMsg: "Okay, today we will focus on cardio. Start with 10 minutes on the treadmill." },
            { id: 24, icon: "ph-film-strip", title: "Movie Theater (సినిమా)", prompt: "Role: Friend. Context: Discussing a movie interval.", startMsg: "The first half was amazing, right? The hero's entry was superb!" },
            { id: 25, icon: "ph-cake", title: "Party (ఫంక్షన్)", prompt: "Role: Host. Context: Welcoming guests to a birthday party.", startMsg: "So glad you could make it! Please come in and have some cake." }
        ];

        const CURRICULUM = [
            { id: 1, phase: "Phase I", title: "Class 01: Pronoun Roles", desc: "Subject (I, We) vs Object (Me, Us)" },
            { id: 2, phase: "Phase I", title: "Class 02: Self-Introduction", desc: "Name, family, profession, hobbies" },
            { id: 3, phase: "Phase I", title: "Class 03: Regular Verbs", desc: "Conjugation patterns (V1, V2, V3)" },
            { id: 4, phase: "Phase I", title: "Class 04: Irregular Verbs", desc: "High frequency irregulars" },
            { id: 5, phase: "Phase I", title: "Class 05: Simple Present", desc: "Habitual actions" },
            { id: 6, phase: "Phase I", title: "Class 06: Simple Present (Do/Does)", desc: "Questions & Negatives" },
            { id: 7, phase: "Phase I", title: "Class 07: WH-Questions", desc: "What, Why, Where, How" },
            { id: 8, phase: "Phase I", title: "Class 08: Simple Past", desc: "Completed actions (V2)" },
            { id: 9, phase: "Phase I", title: "Class 09: Simple Past (Did)", desc: "Past negatives and questions" },
            { id: 10, phase: "Phase I", title: "Class 10: WH-Questions (Did)", desc: "Detailed past inquiries" },
            { id: 11, phase: "Phase I", title: "Class 11: Simple Future", desc: "Will/Shall for future" },
            { id: 12, phase: "Phase I", title: "Class 12: WH-Questions (Future)", desc: "Future inquiries" },
            { id: 13, phase: "Phase II", title: "Class 13: Present Continuous", desc: "Am/Is/Are + V-ing" },
            { id: 14, phase: "Phase II", title: "Class 14: Past Continuous", desc: "Was/Were + V-ing" },
            { id: 15, phase: "Phase II", title: "Class 15: Future Continuous", desc: "Will be + V-ing" },
            { id: 16, phase: "Phase III", title: "Class 16: Can/Could", desc: "Ability & Permission" },
            { id: 17, phase: "Phase III", title: "Class 17: May/Might", desc: "Possibility & Uncertainty" },
            { id: 18, phase: "Phase III", title: "Class 18: Should", desc: "Advice & Duty" },
            { id: 19, phase: "Phase III", title: "Class 19: Must", desc: "Strong Obligation" },
            { id: 20, phase: "Phase III", title: "Class 20: Would", desc: "Past habits & Requests" },
            { id: 21, phase: "Phase IV", title: "Class 21: Have/Has", desc: "Possession" },
            { id: 22, phase: "Phase IV", title: "Class 22: Present Perfect", desc: "Recent past (Have + V3)" },
            { id: 23, phase: "Phase IV", title: "Class 23: Past Perfect", desc: "Action before action (Had + V3)" },
            { id: 24, phase: "Phase IV", title: "Class 24: Future Perfect", desc: "Completed by future" },
            { id: 25, phase: "Phase IV", title: "Class 25: Should have", desc: "Past unfulfilled duties" },
            { id: 26, phase: "Phase IV", title: "Class 26: May have", desc: "Past possibility" },
            { id: 27, phase: "Phase IV", title: "Class 27: Would have", desc: "Hypothetical past" },
            { id: 28, phase: "Phase IV", title: "Class 28: Past Review", desc: "Review of all past forms" },
            { id: 29, phase: "Phase IV", title: "Class 29: Present Perf. Cont.", desc: "Have been + V-ing" },
            { id: 30, phase: "Phase IV", title: "Class 30: Past Perf. Cont.", desc: "Had been + V-ing" },
            { id: 31, phase: "Phase IV", title: "Class 31: Future Perf. Cont.", desc: "Will have been + V-ing" },
            { id: 32, phase: "Phase IV", title: "Class 32: Modal Cont.", desc: "Should be + V-ing" },
            { id: 33, phase: "Phase IV", title: "Class 33: Should have been", desc: "Past continuous modals" },
            { id: 34, phase: "Phase IV", title: "Class 34: Would have been", desc: "Hypothetical continuous" },
            { id: 35, phase: "Phase IV", title: "Class 35: Review", desc: "Synthesis of perfects" },
            { id: 36, phase: "Phase V", title: "Class 36: Have to", desc: "External compulsion" },
            { id: 37, phase: "Phase V", title: "Class 37: Need/Dare", desc: "Necessity & Courage" },
            { id: 38, phase: "Phase V", title: "Class 38: Want/Wish", desc: "Desires & Preferences" },
            { id: 39, phase: "Phase V", title: "Class 39: Able to/Going to", desc: "Ability & Plans" },
            { id: 40, phase: "Phase V", title: "Class 40: Had to", desc: "Past compulsion" },
            { id: 41, phase: "Phase V", title: "Class 41: Used to", desc: "Past habits" },
            { id: 42, phase: "Phase VI", title: "Class 42: Tenses Matrix", desc: "The 12 Tenses Map" },
            { id: 43, phase: "Phase VI", title: "Class 43: Tenses Drill", desc: "Conjugation Practice" },
            { id: 44, phase: "Phase VI", title: "Class 44: Active/Passive", desc: "Voice Transformation" },
            { id: 45, phase: "Phase VI", title: "Class 45: Be with P.P. Form", desc: "Master key: Static states in modal contexts" }
        ];

        let currentlySpeakingText = null;
        const stopAudio = () => {
            if (window.speechSynthesis && typeof window.speechSynthesis.cancel === 'function') {
                window.speechSynthesis.cancel();
            }
            currentlySpeakingText = null;
        };

        let lastRequestTimestamp = parseInt(localStorage.getItem('last_req_time') || '0');
        let requestCount = parseInt(localStorage.getItem('req_count_10m') || '0');
        let reqResetTime = parseInt(localStorage.getItem('req_reset_time') || Date.now().toString());
        const RATE_LIMIT_DELAY = 7000; 

        const checkRateLimit = async (onWait) => {
            const now = Date.now();
            const timeSinceLast = now - lastRequestTimestamp;
            if (timeSinceLast < RATE_LIMIT_DELAY) {
                const wait = RATE_LIMIT_DELAY - timeSinceLast;
                if(onWait) onWait(Math.ceil(wait/1000));
                await new Promise(r => setTimeout(r, wait));
            }
            if (now - reqResetTime > 10 * 60 * 1000) { 
                requestCount = 0;
                reqResetTime = now;
            }
            requestCount++;
            lastRequestTimestamp = Date.now();
            localStorage.setItem('last_req_time', lastRequestTimestamp.toString());
            localStorage.setItem('req_count_10m', requestCount.toString());
            localStorage.setItem('req_reset_time', reqResetTime.toString());
            return requestCount; 
        };

        const shuffleQuizData = (quizArray) => {
            if(!quizArray) return [];
            return quizArray.map(q => {
                if (!q.options || !q.options.length) return q;
                const originalOptions = q.options;
                const correctAnswerText = originalOptions[q.correct];
                let shuffledOptions = [...originalOptions];
                for (let i = shuffledOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
                }
                const newCorrectIndex = shuffledOptions.indexOf(correctAnswerText);
                return { ...q, options: shuffledOptions, correct: newCorrectIndex };
            });
        };

        const generateLessonContent = async (apiKey, modelId, lessonInfo, qCount, prefLang, onWait) => {
            await checkRateLimit(onWait); 
            
            let prompt = "";
            let conceptsFormat = "";
            let quizFormat = "";

            if (prefLang === 'en') {
                conceptsFormat = `"concepts": [{"title": "Concept Name", "explanation": "Concise Telugu explanation...", "examples": [{"te": "...", "en": "..."}, {"te": "...", "en": "..."}]}]`;
                
