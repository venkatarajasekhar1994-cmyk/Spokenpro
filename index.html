<meta name='viewport' content='width=device-width, initial-scale=1'/><meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="SpeakPro - Learn English & Hindi through conversation">
    <title>SpeakPro - Glass PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="1000094592.jpg">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700;800&family=Ramabhadra&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { 
            font-family: 'Open Sans', sans-serif; 
            background-color: #f8fafc; /* slate-50 */
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.3s ease;
        }

        /* Glass Utility Classes */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        /* FIX: Darker text for AI bubble in light mode */
        .glass-bubble-ai {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            color: #020617; /* slate-950 */
            border-radius: 18px 18px 18px 0;
        }
        .glass-input {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .font-telugu { font-family: 'Ramabhadra', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        .animate-spin-slow { animation: spin 1.5s linear infinite; }
        .animate-pulse-ring { animation: pulse-ring 2s infinite; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .bubble-user { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border-radius: 18px 18px 0 18px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .feedback-box { background: rgba(255, 251, 235, 0.9); border-left: 4px solid #f59e0b; color: #92400e; font-size: 0.85rem; backdrop-filter: blur(4px); }
        
        img[src*="placehold.co"] {
            background-color: #e2e8f0; color: #475569; object-fit: cover;
            text-align: center; font-size: 12px; font-family: 'Open Sans', sans-serif;
        }

        /* --- DARK MODE STYLES --- */
        .dark body {
            background-color: #0f172a; /* slate-900 */
        }
        .dark .glass-panel {
            background: rgba(26, 38, 58, 0.75); /* slate-800/75 */
            border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
        }
        .dark .glass-card {
            background: rgba(26, 38, 58, 0.6); /* slate-800/60 */
            border: 1px solid rgba(51, 65, 85, 0.4); /* slate-700/40 */
        }
        .dark .glass-bubble-ai {
            background: rgba(43, 56, 78, 0.85); /* slate-700/85 */
            border: 1px solid rgba(63, 80, 102, 1); /* slate-600 */
            color: #f1f5f9; /* slate-100 */
        }
        .dark .glass-input {
            background: rgba(43, 56, 78, 0.6); /* slate-700/60 */
            border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
            color: white;
        }
        .dark .feedback-box {
            background: rgba(60, 44, 7, 0.9); /* yellow-900/90 */
            border-left: 4px solid #b45309; /* yellow-700 */
            color: #fef9c3; /* yellow-100 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error: error }; }
            componentDidCatch(error, errorInfo) { this.setState({ errorInfo: errorInfo }); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div style={{ padding: '20px', height: '100vh', overflowY: 'auto' }} className="bg-white text-red-700 dark:bg-slate-900 dark:text-red-400">
                            <h1 className="text-xl font-bold">App Error (యాప్‌లో లోపం)</h1>
                            {/* FIX: Darker text */ }
                            <p className="mt-2 text-black dark:text-slate-200">దయచేసి రీలోడ్ చేయండి. లోపం కొనసాగితే, దయచేసి API కీని తనిఖీ చేయండి.</p>
                            <pre style={{ color: 'black', background: '#f3f4f6', padding: '10px', borderRadius: '5px', marginTop: '15px', whiteSpace: 'pre-wrap', wordWrap: 'break-word', border: '1px solid #e5e7eb' }} className="text-black bg-slate-100 dark:text-slate-200 dark:bg-slate-800 border border-slate-200 dark:border-slate-700">
                                <strong>Error: {this.state.error && this.state.error.toString()}</strong>
                            </pre>
                            <button onClick={() => window.location.reload()} className="mt-4 bg-blue-600 text-white p-2 rounded">Reload App</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // Full 25 Scenarios
        const SCENARIOS = [
            { id: 1, icon: "ph-users-three", title: "Family (కుటుంబం)", prompt: "Role: Caring Mother. Context: Asking child about school and lunch.", startMsg: "Hello my dear! How was school today? Did you eat your lunch?" },
            { id: 2, icon: "ph-confetti", title: "Friends (స్నేహితులు)", prompt: "Role: Best Friend. Context: Planning a movie for the weekend.", startMsg: "Hey buddy! Long time no see. Are we going to the movie this Saturday?" },
            { id: 3, icon: "ph-briefcase", title: "Colleagues (ఆఫీస్)", prompt: "Role: Project Manager. Context: Asking about the project deadline status.", startMsg: "Hi, good morning. Have you completed the report I asked for yesterday?" },
            { id: 4, icon: "ph-carrot", title: "Vegetable Market (కూరగాయలు)", prompt: "Role: Vegetable Vendor. Context: Selling fresh tomatoes and negotiating price.", startMsg: "Madam! Fresh tomatoes just arrived. Only 40 rupees a kilo. How much do you need?" },
            { id: 5, icon: "ph-stethoscope", title: "Doctor (డాక్టర్)", prompt: "Role: Doctor. Context: Diagnosing fever and cold symptoms.", startMsg: "Hello. Please sit down. What seems to be the problem today?" },
            { id: 6, icon: "ph-fork-knife", title: "Restaurant (రెస్టారెంట్)", prompt: "Role: Waiter. Context: Taking order for dinner.", startMsg: "Good evening sir/madam. Here is the menu. Would you like to start with some soup?" },
            { id: 7, icon: "ph-user-focus", title: "Job Interview (ఇంటర్వ్యూ)", prompt: "Role: HR Manager. Context: Interviewing for a software developer role.", startMsg: "Welcome. Please introduce yourself and tell me about your experience." },
            { id: 8, icon: "ph-map-pin", title: "Asking Directions (చిరునామా)", prompt: "Role: Local Stranger. Context: Helping someone find the post office.", startMsg: "Excuse me? Are you lost? Where do you want to go?" },
            { id: 9, icon: "ph-bus", title: "Bus Station (బస్)", prompt: "Role: Bus Conductor. Context: Asking for tickets and destination.", startMsg: "Ticket! Ticket! Where to? Move to the back please." },
            { id: 10, icon: "ph-bank", title: "Bank (బ్యాంకు)", prompt: "Role: Bank Manager. Context: Discussing a personal loan application.", startMsg: "Good morning. You wanted to apply for a personal loan, right? Do you have your ID proof?" },
            { id: 11, icon: "ph-shopping-bag", title: "Shopping Mall (షాపింగ్)", prompt: "Role: Sales Executive. Context: Helping customer choose a shirt.", startMsg: "Hello sir. Looking for formal shirts or casuals? We have a new collection." },
            { id: 12, icon: "ph-phone-call", title: "Telephone (ఫోన్)", prompt: "Role: Customer Care. Context: Resolving an internet connection issue.", startMsg: "Thank you for calling Airtel. How may I assist you with your internet connection today?" },
            { id: 13, icon: "ph-house-line", title: "Neighbors (పొరుగువారు)", prompt: "Role: Neighbor. Context: Asking to lower music volume.", startMsg: "Hi there! Sorry to disturb, but could you please lower the music volume a bit?" },
            { id: 14, icon: "ph-chalkboard-teacher", title: "Teacher (టీచర్)", prompt: "Role: Class Teacher. Context: Discussing student's exam marks.", startMsg: "Good morning. I wanted to talk about your son's math marks. He needs to practice more." },
            { id: 15, icon: "ph-ticket", title: "Booking Tickets (టికెట్లు)", prompt: "Role: Ticket Clerk. Context: Booking movie tickets.", startMsg: "Which movie and which show time do you want tickets for?" },
            { id: 16, icon: "ph-bed", title: "Hotel Stay (హోటల్)", prompt: "Role: Receptionist. Context: Guest check-in process.", startMsg: "Welcome to Hotel Taj. Do you have a reservation under your name?" },
            { id: 17, icon: "ph-scissors", title: "Tailor (టైలర్)", prompt: "Role: Tailor. Context: Taking measurements for a dress.", startMsg: "Do you want the sleeves short or long? Let me take your measurements." },
            { id: 18, icon: "ph-wrench", title: "Mechanic (మెకానిక్)", prompt: "Role: Bike Mechanic. Context: Explaining brake failure.", startMsg: "Sir, your bike's rear brake is completely worn out. It needs replacement." },
            { id: 19, icon: "ph-pill", title: "Pharmacy (మందుల షాపు)", prompt: "Role: Pharmacist. Context: Giving medicines for a prescription.", startMsg: "Here are your medicines. Take this yellow tablet after dinner." },
            { id: 20, icon: "ph-siren", title: "Police Station (పోలీస్)", prompt: "Role: Police Inspector. Context: Taking a complaint about a lost phone.", startMsg: "Sit down. When and where did you lose your mobile phone? Tell me the details." },
            { id: 21, icon: "ph-airplane-tilt", title: "Airport (ఎయిర్‌పోర్ట్)", prompt: "Role: Check-in Staff. Context: Checking passport and luggage.", startMsg: "Good morning. May I have your passport and ticket please?" },
            { id: 22, icon: "ph-books", title: "Library (గ్రంథాలయం)", prompt: "Role: Librarian. Context: Issuing a book.", startMsg: "This book is due in 15 days. Please return it on time to avoid a fine." },
            { id: 23, icon: "ph-barbell", title: "Gym (జిమ్)", prompt: "Role: Gym Trainer. Context: Explaining a workout routine.", startMsg: "Okay, today we will focus on cardio. Start with 10 minutes on the treadmill." },
            { id: 24, icon: "ph-film-strip", title: "Movie Theater (సినిమా)", prompt: "Role: Friend. Context: Discussing a movie interval.", startMsg: "The first half was amazing, right? The hero's entry was superb!" },
            { id: 25, icon: "ph-cake", title: "Party (ఫంక్షన్)", prompt: "Role: Host. Context: Welcoming guests to a birthday party.", startMsg: "So glad you could make it! Please come in and have some cake." }
        ];

        // Full 45 Classes
        const CURRICULUM = [
            { id: 1, phase: "Phase I", title: "Class 01: Pronoun Roles", desc: "Subject (I, We) vs Object (Me, Us)" },
            { id: 2, phase: "Phase I", title: "Class 02: Self-Introduction", desc: "Name, family, profession, hobbies" },
            { id: 3, phase: "Phase I", title: "Class 03: Regular Verbs", desc: "Conjugation patterns (V1, V2, V3)" },
            { id: 4, phase: "Phase I", title: "Class 04: Irregular Verbs", desc: "High frequency irregulars" },
            { id: 5, phase: "Phase I", title: "Class 05: Simple Present", desc: "Habitual actions" },
            { id: 6, phase: "Phase I", title: "Class 06: Simple Present (Do/Does)", desc: "Questions & Negatives" },
            { id: 7, phase: "Phase I", title: "Class 07: WH-Questions", desc: "What, Why, Where, How" },
            { id: 8, phase: "Phase I", title: "Class 08: Simple Past", desc: "Completed actions (V2)" },
            { id: 9, phase: "Phase I", title: "Class 09: Simple Past (Did)", desc: "Past negatives and questions" },
            { id: 10, phase: "Phase I", title: "Class 10: WH-Questions (Did)", desc: "Detailed past inquiries" },
            { id: 11, phase: "Phase I", title: "Class 11: Simple Future", desc: "Will/Shall for future" },
            { id: 12, phase: "Phase I", title: "Class 12: WH-Questions (Future)", desc: "Future inquiries" },
            { id: 13, phase: "Phase II", title: "Class 13: Present Continuous", desc: "Am/Is/Are + V-ing" },
            { id: 14, phase: "Phase II", title: "Class 14: Past Continuous", desc: "Was/Were + V-ing" },
            { id: 15, phase: "Phase II", title: "Class 15: Future Continuous", desc: "Will be + V-ing" },
            { id: 16, phase: "Phase III", title: "Class 16: Can/Could", desc: "Ability & Permission" },
            { id: 17, phase: "Phase III", title: "Class 17: May/Might", desc: "Possibility & Uncertainty" },
            { id: 18, phase: "Phase III", title: "Class 18: Should", desc: "Advice & Duty" },
            { id: 19, phase: "Phase III", title: "Class 19: Must", desc: "Strong Obligation" },
            { id: 20, phase: "Phase III", title: "Class 20: Would", desc: "Past habits & Requests" },
            { id: 21, phase: "Phase IV", title: "Class 21: Have/Has", desc: "Possession" },
            { id: 22, phase: "Phase IV", title: "Class 22: Present Perfect", desc: "Recent past (Have + V3)" },
            { id: 23, phase: "Phase IV", title: "Class 23: Past Perfect", desc: "Action before action (Had + V3)" },
            { id: 24, phase: "Phase IV", title: "Class 24: Future Perfect", desc: "Completed by future" },
            { id: 25, phase: "Phase IV", title: "Class 25: Should have", desc: "Past unfulfilled duties" },
            { id: 26, phase: "Phase IV", title: "Class 26: May have", desc: "Past possibility" },
            { id: 27, phase: "Phase IV", title: "Class 27: Would have", desc: "Hypothetical past" },
            { id: 28, phase: "Phase IV", title: "Class 28: Past Review", desc: "Review of all past forms" },
            { id: 29, phase: "Phase IV", title: "Class 29: Present Perf. Cont.", desc: "Have been + V-ing" },
            { id: 30, phase: "Phase IV", title: "Class 30: Past Perf. Cont.", desc: "Had been + V-ing" },
            { id: 31, phase: "Phase IV", title: "Class 31: Future Perf. Cont.", desc: "Will have been + V-ing" },
            { id: 32, phase: "Phase IV", title: "Class 32: Modal Cont.", desc: "Should be + V-ing" },
            { id: 33, phase: "Phase IV", title: "Class 33: Should have been", desc: "Past continuous modals" },
            { id: 34, phase: "Phase IV", title: "Class 34: Would have been", desc: "Hypothetical continuous" },
            { id: 35, phase: "Phase IV", title: "Class 35: Review", desc: "Synthesis of perfects" },
            { id: 36, phase: "Phase V", title: "Class 36: Have to", desc: "External compulsion" },
            { id: 37, phase: "Phase V", title: "Class 37: Need/Dare", desc: "Necessity & Courage" },
            { id: 38, phase: "Phase V", title: "Class 38: Want/Wish", desc: "Desires & Preferences" },
            { id: 39, phase: "Phase V", title: "Class 39: Able to/Going to", desc: "Ability & Plans" },
            { id: 40, phase: "Phase V", title: "Class 40: Had to", desc: "Past compulsion" },
            { id: 41, phase: "Phase V", title: "Class 41: Used to", desc: "Past habits" },
            { id: 42, phase: "Phase VI", title: "Class 42: Tenses Matrix", desc: "The 12 Tenses Map" },
            { id: 43, phase: "Phase VI", title: "Class 43: Tenses Drill", desc: "Conjugation Practice" },
            { id: 44, phase: "Phase VI", title: "Class 44: Active/Passive", desc: "Voice Transformation" },
            { id: 45, phase: "Phase VI", title: "Class 45: Be with P.P. Form", desc: "Master key: Static states in modal contexts" }
        ];

        let currentlySpeakingText = null;
        const stopAudio = () => {
            if (window.speechSynthesis && typeof window.speechSynthesis.cancel === 'function') {
                window.speechSynthesis.cancel();
            }
            currentlySpeakingText = null;
        };

        // --- API రేట్ లిమిటింగ్ లాజిక్ మళ్లీ జోడించబడింది ---
        let lastRequestTimestamp = parseInt(localStorage.getItem('last_req_time') || '0');
        let requestCount = parseInt(localStorage.getItem('req_count_10m') || '0');
        let reqResetTime = parseInt(localStorage.getItem('req_reset_time') || Date.now().toString());
        
        // 10 RPM (6s/req). 9 RPM సురక్షితంగా ఉండటానికి (6.67s/req). 7000ms ఉపయోగిస్తున్నాం.
        const RATE_LIMIT_DELAY = 7000; 

        const checkRateLimit = async (onWait) => {
            const now = Date.now();
            const timeSinceLast = now - lastRequestTimestamp;
            if (timeSinceLast < RATE_LIMIT_DELAY) {
                const wait = RATE_LIMIT_DELAY - timeSinceLast;
                if(onWait) onWait(Math.ceil(wait/1000)); // సెకన్లలో వెయిట్ టైమ్ చూపించు
                await new Promise(r => setTimeout(r, wait));
            }
            // 10 నిమిషాల కౌంటర్‌ (ఇది RPM కంటే భిన్నమైనది, కానీ ఉంచబడింది)
            if (now - reqResetTime > 10 * 60 * 1000) { 
                requestCount = 0;
                reqResetTime = now;
            }
            requestCount++;
            lastRequestTimestamp = Date.now(); // చివరి అభ్యర్థన సమయాన్ని అప్‌డేట్ చేయండి
            localStorage.setItem('last_req_time', lastRequestTimestamp.toString());
            localStorage.setItem('req_count_10m', requestCount.toString());
            localStorage.setItem('req_reset_time', reqResetTime.toString());
            return requestCount; 
        };
        // --- రేట్ లిమిటింగ్ లాజిక్ ముగిసింది ---


        const shuffleQuizData = (quizArray) => {
            if(!quizArray) return [];
            return quizArray.map(q => {
                if (!q.options || !q.options.length) return q;
                const originalOptions = q.options;
                const correctAnswerText = originalOptions[q.correct];
                let shuffledOptions = [...originalOptions];
                for (let i = shuffledOptions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
                }
                const newCorrectIndex = shuffledOptions.indexOf(correctAnswerText);
                return { ...q, options: shuffledOptions, correct: newCorrectIndex };
            });
        };

        // apiKey మరియు onWait పారామీటర్లు జోడించబడ్డాయి
        const generateLessonContent = async (apiKey, modelId, lessonInfo, qCount, prefLang, onWait) => {
            await checkRateLimit(onWait); // రేట్ లిమిట్ కోసం ఆగు
            
            let prompt = "";
            let conceptsFormat = "";
            let quizFormat = "";

            if (prefLang === 'en') {
                conceptsFormat = `"concepts": [{"title": "Concept Name", "explanation": "Concise Telugu explanation...", "examples": [{"te": "...", "en": "..."}, {"te": "...", "en": "..."}]}]`;
                quizFormat = `"quizEnglish": [{"question": "...", "options": ["A", "B", "C", "D"], "correct": 0, "explanation": "Concise 1-line Telugu logic."}]`;
                prompt = `
                    Create ENGLISH MODE content for: "${lessonInfo.title}".
                    REQUIREMENTS:
                    1. CONCEPTS: Explain in Telugu. Give 2 examples.
                    2. EXAMPLES: Must have **ONLY Telugu and English**. NO HINDI.
                    3. QUIZ: Exactly ${qCount} English Qs. NO HINDI QUIZ.
                    4. TOKEN LIMIT: Keep ALL explanations **CONCISE (1-2 lines)**.
                    Output VALID JSON ONLY: { "teluguTitle": "...", ${conceptsFormat}, ${quizFormat} }
                `;
            } else {
                conceptsFormat = `"concepts": [{"title": "Concept Name (EnglishName / हिंदीनाम)", "explanation": "Concise Telugu explanation...", "examples": [{"te": "...", "hi": "..."}, {"te": "...", "hi": "..."}]}]`;
                quizFormat = `"quizHindi": [{"question": "...", "options": ["A", "B", "C", "D"], "correct": 0, "explanation": "Concise 1-line Telugu logic."}]`;
                prompt = `
                    Create HINDI MODE content for: "${lessonInfo.title}".
                    REQUIREMENTS:
                    1. CONCEPTS: Explain in Telugu. For Grammar Terms (Noun, Verb, etc.), provide all three: Telugu (English / हिंदी). E.g., "నామవాచకం (Noun / संज्ञा)".
                    2. EXAMPLES: Must have **ONLY Telugu and Hindi**. NO ENGLISH.
                    3. QUIZ: Exactly ${qCount} Hindi Qs. NO ENGLISH QUIZ.
                    4. TOKEN LIMIT: Keep ALL explanations **CONCISE (1-2 lines)**.
                    Output VALID JSON ONLY: { "teluguTitle": "...", ${conceptsFormat}, ${quizFormat} }
                `;
            }

            try {
                // key="" నుండి key=${apiKey}కి మార్చబడింది
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (response.status === 429) throw new Error("Rate Limit (429). Wait 10s.");
                if (response.status === 503) throw new Error("HTTP Error: 503. Server is busy. Try again.");
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("Model Overloaded. Try reducing Qs or wait.");
                }

                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                let parsedData = JSON.parse(text);

                if (parsedData.quizEnglish) parsedData.quizEnglish = shuffleQuizData(parsedData.quizEnglish);
                if (parsedData.quizHindi) parsedData.quizHindi = shuffleQuizData(parsedData.quizHindi);

                return parsedData;
            } catch (e) { 
                console.error("generateLessonContent API Error:", e, e.message);
                if (e.message.includes("API key")) throw new Error("Invalid API Key.");
                if (e.message.includes("503") || e.message.includes("Overloaded")) {
                     throw new Error("AI Error: HTTP Error: 503. The model is overloaded. Please try again later.");
                }
                throw new Error(`AI Error: ${e.message}.`); 
            }
        };

        // apiKey మరియు onWait పారామీటర్లు జోడించబడ్డాయి
        const callGeminiChat = async (apiKey, modelId, scenarioPrompt, userText, chatLang, onWait) => {
            await checkRateLimit(onWait); // రేట్ లిమిట్ కోసం ఆగు
            const targetLang = chatLang === 'en' ? 'English' : 'Hindi';
            
            const prompt = `
                Persona: ${scenarioPrompt}. Lang: ${targetLang}. User said: "${userText}".
                RULES:
                1. AI Reply: Natural, conversational reply (1-2 sentences) in ${targetLang}.
                2. Translation: Telugu translation for your reply.
                3. Feedback: Check user's text for grammar mistakes.
                   - If NO mistake: "feedback" MUST be null.
                   - If YES mistake: "feedback" MUST be a detailed correction.

                DETAILED CORRECTION FORMAT (VERY IMPORTANT):
                Your feedback MUST follow this structure:
                Correct (సరైన వాక్యం): [Write the full correct sentence here]
                సవరణ (Correction):
                1. [Identify 1st mistake in Telugu and explain rule. e.g., 'go' బదులు 'went' వాడాలి, 'yesterday' గతం (past tense).]
                2. [Identify 2nd mistake if any. e.g., 'market' ముందు 'the' వాడాలి.]

                Output VALID JSON ONLY:
                { "reply": "...", "te_translation": "...", "feedback": "..." }
            `;
            try {
                // key="" నుండి key=${apiKey}కి మార్చబడింది
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                if (!data.candidates || !data.candidates[0].content) {
                    throw new Error("Model Overloaded. Please try again later.");
                }
                let text = data.candidates[0].content.parts[0].text
                    .replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (e) { 
                console.error("callGeminiChat API Error:", e, e.message);
                 if (e.message.includes("Overloaded") || e.message.includes("503") || e.message.includes("500")) {
                    return { 
                        reply: "Error (503)", 
                        te_translation: "లోపం (503)", 
                        feedback: "AI సర్వర్ ప్రస్తుతం బిజీగా ఉంది (503). దయచేసి ఒక నిమిషం ఆగి మళ్లీ ప్రయత్నించండి."
                    };
                 }
                return { reply: "Error.", te_translation: "లోపం.", feedback: e.message };
            }
        };

        const App = () => {
            const [view, setView] = useState('home'); 
            // apiKey స్టేట్ మళ్లీ జోడించబడింది
            const [apiKey, setApiKey] = useState(localStorage.getItem('gemini_api_key') || '');
            const [modelId, setModelId] = useState(localStorage.getItem('gemini_model_id') || 'gemini-2.5-flash');
            const [showSettings, setShowSettings] = useState(false);
            
            // FIX 1: Removed usageLevel state (ఇది ముందే తీసివేయబడింది)
            
            const [selectedLesson, setSelectedLesson] = useState(null);
            const [lessonData, setLessonData] = useState(null);
            const [prefLang, setPrefLang] = useState('en');
            const [prefQCount, setPrefQCount] = useState(5);
            const [quizState, setQuizState] = useState({ index: 0, score: 0, answered: false, selected: null, isCorrect: false, history: [] });
            
            const [activeScenario, setActiveScenario] = useState(null);
            const [chatLang, setChatLang] = useState('en'); 
            const [messages, setMessages] = useState([]);
            const [inputObj, setInputObj] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            
            const [loading, setLoading] = useState(false);
            // waitTime స్టేట్ మళ్లీ జోడించబడింది
            const [waitTime, setWaitTime] = useState(0);
            const [error, setError] = useState(null);
            const [isMuted, setIsMuted] = useState(false);
            const [installPrompt, setInstallPrompt] = useState(null);
            const [theme, setTheme] = useState(localStorage.getItem('speakpro_theme') || 'system');
            
            const chatContainerRef = useRef(null);
            
            useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                });
            }, []);

            useEffect(() => {
                const root = window.document.documentElement; 
                const systemIsDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                if (theme === 'dark' || (theme === 'system' && systemIsDark)) {
                    root.classList.add('dark');
                } else {
                    root.classList.remove('dark');
                }
                localStorage.setItem('speakpro_theme', theme);
                
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                const handleChange = (e) => {
                    if (theme === 'system') {
                        if (e.matches) root.classList.add('dark');
                        else root.classList.remove('dark');
                    }
                };
                mediaQuery.addEventListener('change', handleChange);
                return () => mediaQuery.removeEventListener('change', handleChange);
            }, [theme]);

            useEffect(() => { stopAudio(); }, [view, quizState.index]);
            // waitTime కౌంట్‌డౌన్ useEffect మళ్లీ జోడించబడింది
            useEffect(() => { if (waitTime > 0) { const t = setTimeout(() => setWaitTime(w => w - 1), 1000); return () => clearTimeout(t); } }, [waitTime]);
            useEffect(() => { if (chatContainerRef.current) chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight; }, [messages]);
            
            // FIX 1: Removed usageLevel useEffect (ఇది ముందే తీసివేయబడింది)

            const speak = (text, lang) => {
                if (isMuted || !text) return; 
                if (!window.speechSynthesis) return;
                if (window.speechSynthesis.speaking && text === currentlySpeakingText) { stopAudio(); return; }
                stopAudio();
                const cleanText = text
                    .replace(/[*_#`]/g, '')
                    .replace(/[\(\[].*?[\)\]]/g, '')
                    .replace(/-/g, ' ')
                    .replace('Correct (సరైన వాక్యం):', '')
                    .replace('సవరణ (Correction):', '');
                const utterance = new SpeechSynthesisUtterance(cleanText);
                if (lang === 'te') utterance.lang = 'te-IN';
                else if (lang === 'hi') utterance.lang = 'hi-IN';
                else utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.onstart = () => { currentlySpeakingText = text; };
                utterance.onend = () => { currentlySpeakingText = null; };
                window.speechSynthesis.speak(utterance);
            };

            const saveSettings = () => {
                // apiKey సేవ్ లాజిక్ మళ్లీ జోడించబడింది
                localStorage.setItem('gemini_api_key', apiKey);
                localStorage.setItem('gemini_model_id', modelId);
                setShowSettings(false);
            };

            const handleStartLesson = async (lesson, forceRefresh = false) => {
                if (!apiKey) { setShowSettings(true); return; } // apiKey చెక్ మళ్లీ జోడించబడింది
                setLessonData(null);
                setSelectedLesson(lesson);
                setLoading(true); setWaitTime(0); setError(null); // setWaitTime(0) మళ్లీ జోడించబడింది
                
                try {
                    const cacheKey = `speakpro_v10_l${lesson.id}_q${prefQCount}_${prefLang}`;
                    let data = localStorage.getItem(cacheKey);
                    if (!forceRefresh && data) {
                        await new Promise(r => setTimeout(r, 300));
                        data = JSON.parse(data);
                    } else {
                        // apiKey మరియు onWait కాల్‌బ్యాక్ జోడించబడింది
                        data = await generateLessonContent(apiKey, modelId, lesson, prefQCount, prefLang, (t) => setWaitTime(t));
                        localStorage.setItem(cacheKey, JSON.stringify(data));
                    }
                    if (!data.concepts) throw new Error("AI Error: Data concepts missing.");
                    setLessonData(data);
                    setView('lesson');
                } catch (e) { setError(e.message); } finally { setLoading(false); }
            };
            
            const startQuiz = () => {
                setQuizState({ index: 0, score: 0, answered: false, selected: null, isCorrect: false, history: [] });
                setView('quiz');
            };

            const handleStartChat = (scenario) => {
                if (!apiKey) { setShowSettings(true); return; } // apiKey చెక్ మళ్లీ జోడించబడింది
                setActiveScenario(scenario);
                let greeting = chatLang === 'en' ? scenario.startMsg : "नमस्ते! मैं आपकी कैसे मदद कर सकता हूँ?";
                setMessages([{ role: 'ai', text: greeting, translation: "సంభాషణ ప్రారంభం...", feedback: null }]);
                setView('chat');
            };

            const handleSendChat = async () => {
                if (!apiKey) { setShowSettings(true); return; } // apiKey చెక్ మళ్లీ జోడించబడింది
                if (!inputObj.trim() || loading || waitTime > 0) return; // waitTime చెక్ మళ్లీ జోడించబడింది
                const userText = inputObj;
                setInputObj('');
                setMessages(p => [...p, { role: 'user', text: userText }]);
                setLoading(true);
                try {
                    // apiKey మరియు onWait కాల్‌బ్యాక్ జోడించబడింది
                    const data = await callGeminiChat(apiKey, modelId, activeScenario.prompt, userText, chatLang, (t) => setWaitTime(t));
                    setMessages(p => [...p, { role: 'ai', text: data.reply, translation: data.te_translation, feedback: data.feedback }]);
                    if (data.reply !== "Error." && data.reply !== "Error (503)") speak(data.reply, chatLang);
                } catch (e) { 
                    setMessages(p => [...p, { role: 'ai', text: "Error", translation: "లోపం", feedback: e.message }]);
                } finally { setLoading(false); }
            };

            const startListening = () => {
                if (!('webkitSpeechRecognition' in window)) { alert("No voice support."); return; }
                const rec = new window.webkitSpeechRecognition();
                rec.lang = chatLang === 'en' ? 'en-US' : 'hi-IN';
                rec.onstart = () => setIsRecording(true);
                rec.onend = () => setIsRecording(false);
                rec.onresult = (e) => setInputObj(e.results[0][0].transcript);
                rec.start();
            };

            // --- VIEWS ---

            if (loading && view !== 'chat' && !error) {
                 return (
                    // waitTime లాజిక్ మళ్లీ జోడించబడింది
                    <div className="h-screen flex flex-col items-center justify-center glass-panel p-6 text-center">
                        {waitTime > 0 ? <div className="text-4xl font-bold text-blue-600 mb-2">{waitTime}s</div> : <i className="ph ph-spinner text-4xl text-blue-600 animate-spin-slow mb-4"></i>}
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        <p className="text-black text-sm font-semibold dark:text-gray-300">{waitTime > 0 ? "Safety Wait..." : "Generating Content..."}</p>
                    </div>
                );
            }

            if (error && view !== 'chat') {
                return (
                    <div className="h-screen flex flex-col items-center justify-center glass-panel p-6 text-center">
                        <i className="ph ph-warning text-4xl text-red-500 mb-4"></i>
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        <p className="text-black text-sm font-semibold mb-3 dark:text-gray-300">An Error Occurred</p>
                        <div className="text-red-500 text-xs bg-red-50 p-3 rounded-lg shadow-sm w-full max-w-xs dark:bg-red-900/50 dark:text-red-400">{error}</div>
                        <button onClick={() => { setError(null); setView(view === 'home' ? 'home' : 'course_list'); }} className="mt-6 bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg">Go Back</button>
                        {/* API Key ఎర్రర్ బటన్ మళ్లీ జోడించబడింది */}
                        {error.includes("API Key") && <button onClick={() => { setError(null); setShowSettings(true); }} className="mt-4 text-sm text-black underline dark:text-gray-400">Open Settings</button>}
                    </div>
                );
            }

            // 1. HOME
            if (view === 'home') return (
                <div className="min-h-screen p-4 pb-10 relative">
                    {/* FIX 1: Removed usage bar */}
                    <div className="flex justify-between items-center mb-8 relative z-10 pt-4"> {/* Added pt-4 for spacing */ }
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        <h1 className="text-2xl font-bold text-black flex items-center gap-2 drop-shadow-sm dark:text-slate-200"><i className="ph ph-student text-blue-600 bg-white/50 p-1 rounded-lg"></i> SpeakPro</h1>
                        <div className="flex gap-3">
                             <button onClick={() => setIsMuted(!isMuted)} className={`glass-card p-2.5 rounded-full hover:bg-white active:scale-95 transition-all ${isMuted ? 'text-red-500' : 'text-blue-600'}`}><i className={`ph ${isMuted ? 'ph-speaker-slash' : 'ph-speaker-high'} text-xl`}></i></button>
                             {installPrompt && (
                                <button onClick={handleInstallClick} className="glass-card p-2.5 rounded-full text-green-600 hover:bg-white active:scale-95 transition-all animate-pulse">
                                    <i className="ph ph-download-simple text-xl"></i>
                                </button>
                             )}
                             {/* apiKey మీద ఆధారపడిన క్లాస్ మళ్లీ జోడించబడింది */}
                             <button onClick={() => setShowSettings(true)} className={`glass-card p-2.5 rounded-full hover:bg-white active:scale-95 transition-all ${apiKey ? 'text-black dark:text-gray-300' : 'text-amber-600 animate-bounce'}`}><i className="ph ph-gear text-xl"></i></button>
                        </div>
                    </div>
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-slide-in">
                            <div className="glass-panel p-6 rounded-2xl w-full max-w-sm relative">
                                <button onClick={() => setShowSettings(false)} className="absolute top-3 right-3 text-gray-500 dark:text-gray-400"><i className="ph ph-x text-lg"></i></button>
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <h3 className="font-bold text-lg mb-4 text-black dark:text-slate-200">Settings</h3>
                                {/* API Key ఇన్‌పుట్ మళ్లీ జోడించబడింది */}
                                <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="Paste API Key" className="glass-input w-full p-3 rounded-xl text-sm mb-3 text-black outline-none focus:ring-2 focus:ring-blue-400 dark:text-white dark:placeholder-slate-400" />
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <input type="text" value={modelId} onChange={e => setModelId(e.target.value)} placeholder="Model Name" className="glass-input w-full p-3 rounded-xl text-sm mb-4 text-black outline-none focus:ring-2 focus:ring-blue-400 dark:text-white dark:placeholder-slate-400" />
                                
                                <div className="mb-4">
                                    {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                    <label className="block text-sm font-medium text-black mb-2 dark:text-slate-300">Theme</label>
                                    <div className="flex w-full bg-white/60 dark:bg-slate-700/60 p-1 rounded-xl shadow-inner border border-white/40 dark:border-slate-700">
                                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                        <button onClick={() => setTheme('light')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1 ${theme === 'light' ? 'bg-white text-blue-600 shadow' : 'text-black dark:text-slate-400'}`}>
                                            <i className="ph ph-sun"></i> Light
                                        </button>
                                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                        <button onClick={() => setTheme('dark')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1 ${theme === 'dark' ? 'bg-slate-900 text-white shadow' : 'text-black dark:text-slate-400'}`}>
                                            <i className="ph ph-moon"></i> Dark
                                        </button>
                                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                        <button onClick={() => setTheme('system')} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-1 ${theme === 'system' ? 'bg-white text-blue-600 shadow dark:bg-slate-600 dark:text-white' : 'text-black dark:text-slate-400'}`}>
                                            <i className="ph ph-gear-six"></i> System
                                        </button>
                                    </div>
                                </div>

                                <button onClick={saveSettings} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition-colors">Save & Close</button>
                            </div>
                        </div>
                    )}
                    <div className="grid gap-5">
                        <button onClick={() => setView('course_list')} className="glass-card p-6 rounded-3xl text-left relative overflow-hidden group active:scale-95 transition-transform hover:bg-white/80">
                             <div className="absolute top-0 right-0 bg-blue-500 w-24 h-24 rounded-bl-full -mr-10 -mt-10 opacity-20"></div>
                             <i className="ph ph-book-open text-4xl text-blue-700 mb-3 drop-shadow-sm"></i>
                             {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                             <h2 className="text-xl font-bold text-black dark:text-slate-200">45-Day Course</h2>
                             {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                             <p className="text-black text-sm mt-1 font-medium dark:text-slate-400">Grammar & Quizzes</p>
                        </button>
                        <button onClick={() => setView('roleplay_list')} className="glass-card p-6 rounded-3xl text-left relative overflow-hidden group active:scale-95 transition-transform hover:bg-white/80">
                             <div className="absolute top-0 right-0 bg-emerald-500 w-24 h-24 rounded-bl-full -mr-10 -mt-10 opacity-20"></div>
                             <i className="ph ph-chats-circle text-4xl text-emerald-700 mb-3 drop-shadow-sm"></i>
                             {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                             <h2 className="text-xl font-bold text-black dark:text-slate-200">Role Play</h2>
                             {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                             <p className="text-black text-sm mt-1 font-medium dark:text-slate-400">Real Conversations</p>
                        </button>
                    </div>
                </div>
            );

            // 2. COURSE LIST
            if (view === 'course_list') return (
                <div className="min-h-screen p-4 pb-10">
                    <div className="glass-panel sticky top-4 p-3 rounded-xl mb-6 z-20 flex items-center gap-4">
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        <button onClick={() => setView('home')} className="text-black p-2 hover:bg-white/50 rounded-full dark:text-gray-300"><i className="ph ph-arrow-left text-xl"></i></button>
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        <h2 className="font-bold text-lg text-black dark:text-slate-200">Select Class</h2>
                    </div>
                    <div className="glass-card p-4 rounded-2xl mb-4">
                        <div className="flex gap-2 mb-3">
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <button onClick={() => setPrefLang('en')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm ${prefLang === 'en' ? 'bg-blue-600 text-white' : 'bg-white/60 text-black dark:bg-slate-700/60 dark:text-slate-300'}`}>English</button>
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <button onClick={() => setPrefLang('hi')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm ${prefLang === 'hi' ? 'bg-orange-600 text-white' : 'bg-white/60 text-black dark:bg-slate-700/60 dark:text-slate-300'}`}>Hindi</button>
                        </div>
                        <div className="flex gap-2">
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            {[3, 5, 10].map(n => <button key={n} onClick={() => setPrefQCount(n)} className={`flex-1 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm ${prefQCount === n ? 'bg-slate-800 text-white dark:bg-blue-500' : 'bg-white/60 text-black dark:bg-slate-700/60 dark:text-slate-300'}`}>{n} Qs</button>)}
                        </div>
                    </div>
                    <div className="space-y-3">
                        {CURRICULUM.map(l => (
                            <button key={l.id} onClick={() => handleStartLesson(l)} className="w-full glass-card p-4 rounded-2xl flex items-center justify-between active:scale-95 transition-all hover:bg-white/80">
                                <div className="text-left">
                                    <span className="text-[10px] bg-blue-100/80 text-blue-700 px-2 py-1 rounded font-bold backdrop-blur-sm dark:bg-blue-900/80 dark:text-blue-200">Class {l.id}</span>
                                    {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                    <h3 className="font-bold text-black text-sm mt-1 dark:text-slate-200">{l.title.split(':')[1]}</h3>
                                </div>
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <i className="ph ph-caret-right text-black dark:text-gray-400"></i>
                            </button>
                        ))}
                    </div>
                </div>
            );

            // 3. LESSON VIEW
            if (view === 'lesson') {
                if (!lessonData || !lessonData.concepts) return null; 
                return (
                <div className="min-h-screen pb-24">
                    <div className="glass-panel sticky top-0 z-20 p-4 flex justify-between items-center border-b-0 shadow-lg backdrop-blur-xl">
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        <button onClick={() => setView('course_list')} className="text-black p-2 hover:bg-white/50 rounded-full dark:text-gray-300"><i className="ph ph-arrow-left text-xl"></i></button>
                        <span className={`text-xs font-bold px-3 py-1 rounded-full backdrop-blur-sm ${prefLang === 'en' ? 'bg-blue-100/80 text-blue-800 dark:bg-blue-900/80 dark:text-blue-200' : 'bg-orange-100/80 text-orange-800 dark:bg-orange-900/80 dark:text-orange-200'}`}>{prefLang === 'en' ? 'English' : 'Hindi'} Mode</span>
                        <button onClick={() => { if(confirm('Refresh? This will use API quota.')) handleStartLesson(selectedLesson, true); }} className="p-2 rounded-full bg-blue-50/80 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/80 dark:text-blue-300 dark:hover:bg-blue-800"><i className="ph ph-arrows-clockwise text-xl"></i></button>
                    </div>
                    <div className="p-4 space-y-6 animate-slide-in">
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        <div className="text-center my-2 glass-card p-3 rounded-xl inline-block w-full"><h3 className="text-lg font-telugu font-bold text-black leading-snug dark:text-slate-200">{lessonData.teluguTitle}</h3></div>
                        {lessonData.concepts.map((c, i) => (
                            <div key={i} className="glass-card p-5 rounded-3xl">
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <h3 className="font-bold text-black mb-3 flex items-center gap-2 text-sm uppercase tracking-wide dark:text-slate-200"><i className="ph ph-sparkle text-yellow-500 drop-shadow-sm"></i> {c.title}</h3>
                                <div className="bg-white/60 p-4 rounded-xl mb-4 relative group border border-white/50 shadow-inner dark:bg-slate-800/60">
                                    {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                    <p className="text-black text-sm font-telugu leading-relaxed pr-8 font-medium dark:text-slate-200">{c.explanation}</p>
                                    {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-gray-900) */}
                                    <button onClick={() => speak(c.explanation, 'te')} className="absolute top-3 right-3 text-gray-900 hover:text-blue-600 bg-white/80 dark:bg-slate-600/50 dark:text-slate-400 dark:hover:text-blue-400 p-1.5 rounded-full shadow-sm"><i className="ph ph-speaker-high"></i></button>
                                </div>
                                <div className="space-y-3">
                                    {c.examples.map((ex, j) => (
                                        <div key={j} className={`border-l-4 pl-4 py-2 ${prefLang === 'en' ? 'border-blue-500' : 'border-orange-500'} bg-white/40 rounded-r-xl backdrop-blur-sm dark:bg-slate-700/30`}>
                                            <div className="flex justify-between items-start mb-1">
                                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                                <span className="text-xs text-black font-telugu font-semibold dark:text-slate-400">{ex.te}</span>
                                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-gray-900) */}
                                                <button onClick={() => speak(ex.te, 'te')} className="text-gray-900 hover:text-black dark:text-gray-500 dark:hover:text-gray-300"><i className="ph ph-speaker-simple-high text-xs"></i></button>
                                            </div>
                                            <div className="flex flex-col gap-1 mt-1">
                                                 {prefLang === 'en' && ex.en && (
                                                     <div className="flex justify-between items-center">
                                                        <span className="font-bold text-blue-800 text-sm dark:text-blue-300">{ex.en}</span>
                                                        <button onClick={() => speak(ex.en, 'en')} className="text-blue-400 hover:text-blue-700 dark:text-blue-500 dark:hover:text-blue-300"><i className="ph ph-speaker-high text-xs"></i></button>
                                                    </div>
                                                 )}
                                                {prefLang === 'hi' && ex.hi && (
                                                    <div className="flex justify-between items-center">
                                                        <span className="font-bold text-orange-800 text-sm dark:text-orange-300">{ex.hi}</span>
                                                        <button onClick={() => speak(ex.hi, 'hi')} className="text-orange-400 hover:text-orange-700 dark:text-orange-500 dark:hover:text-orange-300"><i className="ph ph-speaker-high text-xs"></i></button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="fixed bottom-0 left-0 right-0 p-4 glass-panel border-t-0 flex justify-center z-20"><button onClick={startQuiz} className={`w-full max-w-md text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 flex items-center justify-center gap-2 ${prefLang === 'en' ? 'bg-blue-600/90 hover:bg-blue-600' : 'bg-orange-600/90 hover:bg-orange-600'} backdrop-blur-md`}>
                            Start Quiz ({prefQCount} Qs) <i className="ph ph-caret-right"></i>
                        </button>
                    </div>
                </div>
            );}

            // 4. QUIZ VIEW
            if (view === 'quiz') {
                if (!lessonData) return null; 
                const currentQuiz = prefLang === 'en' ? lessonData.quizEnglish : lessonData.quizHindi;
                
                if (!currentQuiz || currentQuiz.length === 0 || !currentQuiz[quizState.index]) { 
                    setTimeout(() => setView('result'), 100); 
                    return null; 
                }
                
                const q = currentQuiz[quizState.index];
                const color = prefLang === 'en' ? 'blue' : 'orange';

                return (
                    <div className={`min-h-screen flex flex-col relative`}>
                         <div className={`absolute inset-0 bg-${color}-500/10 backdrop-blur-sm pointer-events-none`}></div>
                        <div className="p-6 flex justify-between items-center relative z-10">
                            <button onClick={() => setView('lesson')} className={`p-2 rounded-full glass-card text-${color}-700 dark:text-${color}-300`}><i className="ph ph-x"></i></button>
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <div className={`px-3 py-1 rounded-full glass-card text-black dark:text-${color}-200 text-xs font-bold`}>Q {quizState.index + 1} / {currentQuiz.length}</div>
                            <div className="w-10 h-10"></div>
                        </div>
                        <div className="flex-1 px-6 flex flex-col justify-center pb-20 relative z-10">
                            <div className="glass-panel p-8 rounded-3xl mb-6 text-center relative">
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <h2 className="text-xl font-bold text-black font-telugu leading-relaxed dark:text-slate-200">{q.question}</h2>
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-gray-900) */}
                                <button onClick={() => speak(q.question, 'te')} className="absolute top-4 right-4 text-gray-900 hover:text-blue-600 dark:text-gray-500 dark:hover:text-blue-400"><i className="ph ph-speaker-high"></i></button>
                            </div>
                            <div className="space-y-3">
                                {q.options.map((opt, idx) => {
                                    {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                    let style = "glass-card text-black hover:bg-white/70 dark:text-slate-200";
                                    if (quizState.answered) {
                                        if (idx === q.correct) { style = "bg-green-500 text-white border-green-500 shadow-lg"; }
                                        else if (idx === quizState.selected) { style = "bg-red-500 text-white border-red-500 shadow-lg"; }
                                        else { style = "glass-card opacity-50 dark:opacity-50 dark:bg-slate-700/50"; }
                                    }
                                    return (
                                        <button key={idx} onClick={() => { 
                                            if(quizState.answered) return; 
                                            const isCorrect = idx === q.correct;
                                            const newHistory = [...quizState.history, { question: q.question, correctAns: q.options[q.correct], userAns: opt, isCorrect }];
                                            setQuizState({ ...quizState, answered: true, selected: idx, isCorrect, score: isCorrect ? quizState.score + 1 : quizState.score, history: newHistory }); 
                                        }} disabled={quizState.answered} className={`w-full p-4 rounded-xl border font-semibold transition-all flex justify-between items-center active:scale-98 ${style}`}>
                                            <span>{opt}</span>
                                        </button>
                                    )
                                })}
                            </div>
                            {quizState.answered && (
                                <div className="mt-6 animate-slide-in">
                                    {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                    <div className={`glass-panel p-4 rounded-2xl border-l-4 ${quizState.isCorrect ? 'border-green-500' : 'border-red-500'} mb-4 text-sm font-telugu text-black dark:text-slate-200 flex justify-between gap-2`}>
                                        <span className="flex-1 leading-relaxed">{q.explanation}</span>
                                        <button onClick={() => speak(q.explanation, 'te')} className="text-blue-600 shrink-0 dark:text-blue-400"><i className="ph ph-speaker-high"></i></button>
                                    </div>
                                    <button onClick={() => { if (quizState.index < currentQuiz.length - 1) setQuizState({ ...quizState, index: quizState.index + 1, answered: false, selected: null, isCorrect: false, history: quizState.history }); else setView('result'); }} className={`w-full bg-${color}-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 hover:bg-${color}-700 transition-colors`}>Next <i className="ph ph-arrow-right"></i></button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // 5. RESULT VIEW
            if (view === 'result') {
                if (!lessonData) return null; 
                
                const quizData = prefLang === 'en' ? lessonData.quizEnglish : lessonData.quizHindi;
                const total = (quizData && quizData.length > 0) ? quizData.length : 0;
                
                if (total === 0) {
                     return (
                        <div className="h-screen p-4 flex flex-col items-center justify-center glass-panel">
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <h2 className="text-xl font-bold text-black mb-4 dark:text-slate-200">Quiz Complete</h2>
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <p className="text-black mb-6 dark:text-slate-400">No questions were found for this quiz.</p>
                            <button onClick={() => setView('course_list')} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg">Back to Menu</button>
                        </div>
                     );
                }

                const percentage = Math.round((quizState.score / total) * 100);
                const passed = percentage >= 70;
                
                return (
                    <div className="h-screen p-4 flex flex-col items-center justify-center">
                         <div className="glass-panel w-full max-w-lg rounded-3xl flex flex-col h-[85vh] overflow-hidden relative">
                             {passed && <div className="absolute inset-0 bg-yellow-400/10 z-0 pointer-events-none"></div>}
                            <div className="relative z-10 text-center p-6 border-b border-white/40 shrink-0">
                                {passed ? <i className="ph ph-medal text-yellow-500 text-6xl mb-2 animate-bounce drop-shadow-md"></i> : <i className="ph ph-smiley-sad text-gray-400 dark:text-gray-400 text-6xl mb-2"></i>}
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <h2 className="text-2xl font-bold text-black dark:text-slate-200">{passed ? "Excellent!" : "Practice More"}</h2>
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <div className="mt-2 inline-block bg-white/60 px-4 py-1 rounded-full text-lg font-bold text-black shadow-sm dark:bg-slate-700 dark:text-slate-200">{percentage}% Score</div>
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <p className="text-xs text-black mt-1 dark:text-slate-400">{quizState.score} / {total} Correct</p>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 bg-white/30 dark:bg-slate-800/30">
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <h3 className="font-bold text-black mb-3 text-xs uppercase tracking-wider opacity-70 dark:text-slate-300">Review Answers</h3>
                                <div className="space-y-3">
                                    {quizState.history.map((item, i) => (
                                        <div key={i} className="bg-white/70 p-3 rounded-xl border border-white shadow-sm dark:bg-slate-700/70 dark:border-slate-700">
                                            <div className="flex justify-between mb-1">
                                                 {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                                 <span className="text-xs font-bold text-black dark:text-gray-400">Q{i+1}</span>
                                                 {item.isCorrect ? <i className="ph ph-check text-green-600"></i> : <i className="ph ph-x text-red-500"></i>}
                                            </div>
                                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                            <p className="font-telugu text-black text-sm mb-2 font-medium dark:text-slate-200">{item.question}</p>
                                            {!item.isCorrect && (
                                                <div className="text-xs flex flex-col gap-1 bg-red-50 p-2 rounded-lg dark:bg-red-900/50">
                                                    <div className="text-red-600 line-through opacity-70 dark:text-red-400">{item.userAns}</div>
                                                    <div className="text-green-700 font-bold dark:text-green-400">Correct: {item.correctAns}</div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="p-4 border-t border-white/40 shrink-0 bg-white/40 backdrop-blur-md dark:bg-slate-800/40 dark:border-slate-700 flex gap-3">
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <button onClick={() => setView('lesson')} className="flex-1 bg-white text-black font-bold py-3 px-4 rounded-xl shadow-sm hover:bg-gray-50 text-sm dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">Retry</button>
                                {passed ? (
                                    <button onClick={() => {
                                        const nextId = parseInt(selectedLesson.id) + 1;
                                        const nextLesson = CURRICULUM.find(l => l.id === nextId);
                                        if (nextLesson) {
                                            handleStartLesson(nextLesson);
                                        } else {
                                            alert("Course Completed!");
                                            setView('course_list');
                                        }
                                    }} className="flex-[2] bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-green-700 text-sm flex items-center justify-center gap-2">Next Class <i className="ph ph-arrow-right"></i></button>
                                ) : (
                                    <button onClick={() => setView('course_list')} className="flex-[2] bg-blue-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-blue-700 text-sm">Back to Menu</button>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }
            
            // 6. ROLE PLAY LIST
            if (view === 'roleplay_list') return (
                <div className="min-h-screen p-4 pb-safe">
                     <div className="glass-panel sticky top-4 z-20 py-2 px-3 rounded-xl mb-6 flex items-center justify-between">
                        <div className="flex items-center gap-2">
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <button onClick={() => setView('home')} className="text-black p-2 hover:bg-white/50 rounded-full dark:text-gray-300"><i className="ph ph-arrow-left text-xl"></i></button>
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <h2 className="font-bold text-lg text-black dark:text-slate-200">Choose Scenario</h2>
                        </div>
                        <div className="flex bg-white/60 p-1 rounded-lg shadow-inner ml-auto border border-white/40 dark:bg-slate-700/60 dark:border-slate-700">
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <button onClick={() => setChatLang('en')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${chatLang === 'en' ? 'bg-blue-100/80 text-blue-600 dark:bg-blue-900/80 dark:text-blue-200' : 'text-black dark:text-gray-400'}`}>ENG</button>
                            {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                            <button onClick={() => setChatLang('hi')} className={`px-3 py-1 rounded text-xs font-bold transition-all ${chatLang === 'hi' ? 'bg-orange-100/80 text-orange-600 dark:bg-orange-900/80 dark:text-orange-200' : 'text-black dark:text-gray-400'}`}>HIN</button>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-3">
                        {SCENARIOS.map(s => (
                            <button key={s.id} onClick={() => handleStartChat(s)} className="glass-card p-4 rounded-2xl text-center active:scale-95 transition-all hover:bg-white/80">
                                <i className={`ph ${s.icon} text-3xl text-blue-600 mb-2 drop-shadow-sm`}></i>
                                {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                <h3 className="font-bold text-black text-xs leading-tight font-telugu dark:text-slate-300">{s.title}</h3>
                            </button>
                        ))}
                    </div>
                </div>
            );

            // 7. CHAT
            if (view === 'chat') {
                if (!activeScenario) return null;
                return (
                <div className="min-h-screen flex flex-col relative">
                     <div className="absolute inset-0 bg-indigo-500/5 pointer-events-none backdrop-blur-sm"></div>
                    <div className="glass-panel p-3 flex items-center gap-3 z-20 justify-between rounded-b-2xl shadow-md">
                        <div className="flex items-center gap-3">
                             {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                             <button onClick={() => setView('roleplay_list')} className="text-black p-1 dark:text-gray-300"><i className="ph ph-arrow-left text-xl"></i></button>
                             {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                             <div><h2 className="font-bold text-black text-sm font-telugu dark:text-slate-200">{activeScenario.title}</h2><p className="text-[10px] text-black font-bold uppercase dark:text-slate-400">{chatLang === 'en' ? 'English' : 'Hindi'} Mode</p></div>
                        </div>
                    </div>
                    <div ref={chatContainerRef} className="flex-1 overflow-y-auto p-4 space-y-6 relative z-10">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.role === 'user' ? 'items-end' : 'items-start'}`}>
                                <div className={`max-w-[85%] p-3.5 text-sm relative group shadow-md backdrop-blur-md ${m.role === 'user' ? 'bubble-user' : 'glass-bubble-ai'}`}>
                                    {m.text}
                                    {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                    {m.role === 'ai' && <button onClick={() => speak(m.text, chatLang)} className="absolute -right-8 top-1 text-black hover:text-blue-600 p-1 bg-white/60 rounded-full shadow-sm dark:text-gray-400 dark:bg-slate-700/60 dark:hover:text-blue-400"><i className="ph ph-speaker-high text-base"></i></button>}
                                </div>
                                {m.role === 'ai' && (
                                    <div className="max-w-[85%] mt-1 space-y-1">
                                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                                        <div className="text-xs text-black font-telugu bg-white/60 px-2 py-1 rounded-md border border-white/50 shadow-sm backdrop-blur-md dark:bg-slate-700/60 dark:text-slate-400 dark:border-slate-700">
                                            {m.translation}
                                        </div>
                                        {m.feedback && (
                                            <div className="feedback-box p-3 rounded-xl text-xs font-telugu shadow-sm mt-2">
                                                <div className="flex justify-between items-center mb-1">
                                                    <strong className="block flex items-center gap-1 text-amber-800 dark:text-amber-200"><i className="ph ph-warning-circle"></i> సవరణ (Correction):</strong>
                                                    <button onClick={() => speak(m.feedback, 'te')} className="ml-2 text-amber-700 hover:text-amber-900 dark:text-amber-300 dark:hover:text-amber-100"><i className="ph ph-speaker-high"></i></button>
                                                </div>
                                                <p className="whitespace-pre-wrap font-medium">{m.feedback}</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        ))}
                        {loading && <div className="flex justify-start"><div className="glass-card p-3 rounded-xl rounded-bl-none flex gap-1 shadow-sm"><div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce"></div><div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce delay-75"></div><div className="w-1.5 h-1.5 bg-blue-500 rounded-full animate-bounce delay-150"></div></div></div>}
                    </div>
                    <div className="glass-panel p-3 border-t border-white/30 flex items-center gap-2 z-20">
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        {/* waitTime చెక్ మళ్లీ జోడించబడింది */}
                        <button onClick={startListening} disabled={waitTime > 0 || loading} className={`p-3 rounded-full transition-all flex-shrink-0 shadow-sm border border-white/50 ${isRecording ? 'bg-red-500 text-white animate-pulse-ring' : 'bg-white/60 text-black hover:bg-white dark:bg-slate-700 dark:text-slate-300 dark:hover:bg-slate-600'}`}><i className={`ph ${isRecording ? 'ph-microphone-slash' : 'ph-microphone'} text-xl`}></i></button>
                        {/* ఫాంట్ రంగు నలుపుగా ఉంది (text-black) */}
                        {/* waitTime చెక్ మరియు ప్లేస్‌హోల్డర్ మళ్లీ జోడించబడింది */}
                        <input type="text" value={inputObj} onChange={(e) => setInputObj(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSendChat()} placeholder={waitTime > 0 ? `Wait ${waitTime}s...` : isRecording ? "Listening..." : "Type message..."} className="flex-1 glass-input border-transparent rounded-full px-4 py-2.5 text-sm outline-none focus:ring-2 focus:ring-blue-400 placeholder-black text-black dark:placeholder-slate-400 dark:text-white" disabled={waitTime > 0 || loading} />
                        {/* waitTime చెక్ మళ్లీ జోడించబడింది */}
                        <button onClick={handleSendChat} disabled={!inputObj.trim() || waitTime > 0 || loading} className={`p-3 rounded-full flex-shrink-0 shadow-lg border border-white/20 ${!inputObj.trim() || waitTime > 0 || loading ? 'bg-gray-200/50 text-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 active:scale-90'} transition-all`}><i className="ph ph-paper-plane-right text-xl"></i></button>
                    </div>
                </div>
            );}

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker Registered!', reg.scope))
                    .catch(err => console.log('Service Worker Failed:', err));
            });
        }
    </script>
</body>
</html>


